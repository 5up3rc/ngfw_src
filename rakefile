# -*-ruby-*-

SRC_HOME = "."

require "#{SRC_HOME}/buildtools/untangle-core.rb"

task :default => :devel
task :all => :devel

task :clean do
  Kernel.system( "make -C downloads distclean" )
  FileUtils.rm_rf(BuildEnv::SRC.devel) if File.exist?(BuildEnv::SRC.devel)
  FileUtils.rm_rf(BuildEnv::SRC.staging) if File.exist?(BuildEnv::SRC.staging)
  FileUtils.rm_rf("foo.dot") if File.exist?("foo.dot")
  FileUtils.rm_rf(FileList['debian/*'].select { |f| File.directory?(f) })
  ## Clear the stamp hashes
  Rake::StampHash.instance.clear
end

task :kindaclean do
  FileUtils.rm_rf(BuildEnv::SRC.devel) if File.exist?(BuildEnv::SRC.devel)
  FileUtils.rm_rf(BuildEnv::SRC.staging) if File.exist?(BuildEnv::SRC.staging)
  FileUtils.rm_rf("foo.dot") if File.exist?("foo.dot")
  FileUtils.rm_rf(FileList['debian/*'].select { |f| File.directory?(f) })
  ## Clear the stamp hashes
  Rake::StampHash.instance.clear
end

task :build => [BuildEnv::SRC['untangle-vm'], BuildEnv::SRC['untangle-client'], BuildEnv::SRC['node']]

task :devel => [BuildEnv::SRC['install'], BuildEnv::SRC.installTarget]

# See rake-util.rb, we check the arguments for "pkgs"
task :install => [BuildEnv::SRC['install'], BuildEnv::SRC.installTarget] do
  # FIXME: hrm, we're taking init scripts from the staging area under
  # debian/packagename/... and put it back under debian/ ????
  FileList["#{SRC_HOME}/debian/**/etc/init.d/*"].each do |f|
    FileUtils.cp(f, "#{SRC_HOME}/debian/#{File.basename(f)}.init")
  end
end

task :javadoc do
  dirs = (FileList['**/api'] + FileList['**/localapi'] + FileList['**/impl']).select { |e| not (/downloads/ =~ e or /staging/ =~ e or /dist/ =~ e) }.join(':')

  Kernel.exec('javadoc', '-splitindex','-docencoding','UTF-8','-use','-docfilessubdirs', '-sourcepath', dirs,
              '-d', "#{BuildEnv::SRC.staging}/javadoc",
              '-subpackages', 'com.untangle', '-J-Xmx512m')
end
