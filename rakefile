# -*-ruby-*-
# $Id$

verbose(false) #disable printing of rake mkdir messages

## generic framework
require "./buildtools/buildtools.rb"

## default tasks
task :default => :devel
task :all => :devel

## clean tasks
task :download_clean do
  Kernel.system( "make --no-print-directory -C downloads distclean" )
end

task :kindaclean do
  info "[rm -rf  ] #{BuildEnv::SRC.devel}"
  FileUtils.rm_rf(BuildEnv::SRC.devel) if File.exist?(BuildEnv::SRC.devel)
  info "[rm -rf  ] #{BuildEnv::SRC.staging}"
  FileUtils.rm_rf(BuildEnv::SRC.staging) if File.exist?(BuildEnv::SRC.staging)
  info "[rm -rf  ] foo.dot"
  FileUtils.rm_rf("foo.dot") if File.exist?("foo.dot")
  info "[rm -rf  ] debian/dirs"
  FileUtils.rm_rf(FileList['debian/*'].select { |f| File.directory?(f) })
  ## Clear the stamp hashes
  Rake::StampHash.instance.clear
end

task :clean => [:download_clean, :kindaclean]

## download task; it is needed by both arch-dep and arch-indep,
## because Jars.findJars sets up the base classpath used everywhere
task :download do
  Kernel.system("make --no-print-directory -C downloads")
  raise unless $?.success?
  Jars.findJars
end

## arch-dep tasks
task :core => :download do
  require "./buildtools/untangle-core.rb"
end
task :builduvmcore => [:core, :libuvmcore_so]
task :installuvmcore => [:builduvmcore, :dest_uvmcore_so]

## arch-indep tasks
task :targets => :download do
  # Require all arch-indep sub packages; done manually because order
  # matters.
  require "#{SRC_HOME}/uvm/package.rb"
  require "#{SRC_HOME}/reporting/package.rb"
  require "#{SRC_HOME}/ftp-casing/package.rb"
  require "#{SRC_HOME}/http-casing/package.rb"
  require "#{SRC_HOME}/smtp-casing/package.rb"
  require "#{SRC_HOME}/router/package.rb"
  require "#{SRC_HOME}/shield/package.rb"
  require "#{SRC_HOME}/firewall/package.rb"
  require "#{SRC_HOME}/openvpn/package.rb"
  require "#{SRC_HOME}/protofilter/package.rb"
  require "#{SRC_HOME}/idps/package.rb"
  require "#{SRC_HOME}/ips/package.rb"
  # Base Nodes
  require "#{SRC_HOME}/spam-base/package.rb"
  require "#{SRC_HOME}/virus-base/package.rb"
  require "#{SRC_HOME}/clam-base/package.rb"
  require "#{SRC_HOME}/webfilter-base/package.rb"
  # Spam based nodes
  require "#{SRC_HOME}/phish/package.rb"
  require "#{SRC_HOME}/spamassassin/package.rb"
  # Webfilter based nodes
  require "#{SRC_HOME}/webfilter/package.rb"
  # Ad Blocker node
  require "#{SRC_HOME}/adblocker/package.rb"
  # Virus based nodes
  require "#{SRC_HOME}/clam/package.rb"
  # New captive portal
  require "#{SRC_HOME}/capture/package.rb"
end

task :build => [:builduvmcore, :targets, BuildEnv::SRC['untangle-vm'], BuildEnv::SRC['node'] ]

task :hier => [:targets, BuildEnv::SRC.hierTarget]

task :i18n => BuildEnv::SRC.i18nTarget

task :devel => [:build, :hier, BuildEnv::SRC['install'], BuildEnv::SRC.installTarget]

task :debian_init_files do
  FileList["./debian/**/etc/init.d/*"].each do |f|
    FileUtils.cp(f, "./debian/#{File.basename(f)}.init")
  end
end

task :install => [:devel, :i18n, :debian_init_files]

task :javadoc do
  dirs = 'uvm/api'
  cpath = FileList['staging/*'].map { |e| "#{e}/" }.join(':') + ":" + FileList['downloads/output/**/*jar'].join(':')
  css = "./buildtools/javadoc.css"

  Kernel.exec('javadoc', '-splitindex','-docencoding','UTF-8','-use','-docfilessubdirs', '-stylesheetfile', css, '-sourcepath', dirs, '-classpath', cpath,
              '-d', "#{BuildEnv::SRC.staging}/javadoc",
              '-subpackages', 'com.untangle', '-J-Xmx512m')
end
