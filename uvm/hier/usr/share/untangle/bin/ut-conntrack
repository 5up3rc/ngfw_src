#!/bin/dash

first=0
count=0

echo -n "{ javaClass: java.util.LinkedList, list : ["

cat /proc/net/ip_conntrack | grep -v '127.0.0.1' | sed 's/\[.*\]//g' | sed 's/[a-z]*=//g' | while read i ; do
    if [ $first -eq 0 ] ; then first=1 ; else echo -n "," ; fi


    # marks
    # 0x01000000 (antisubscribe/bypass) 24 bits left
    # 0x00700000 (QoS) 20 bits left
    # 0x00010000 (local traffic) 8 bits left

    if [ "`echo $i | grep tcp`" ] ; then
        echo $i | awk '{printf "{ protocol:\"%s\", state:\"%s\", preNatClient:\"%s\", preNatServer:\"%s\", preNatClientPort:\"%s\", preNatServerPort:\"%s\", packets:\"%s\", bytes:\"%s\", postNatClient:\"%s\", postNatServer:\"%s\", postNatClientPort:\"%s\", postNatServerPort:\"%s\", qosPriority:\"%x\", bypassed:\"%s\", localTraffic:\"%s\", javaClass:\"com.untangle.uvm.SessionMonitorEntry\" }\n", toupper($1), $4, $5, $6, $7, $8, $9, $10, $12, $11, $14, $13, rshift(and($17,0x00700000),20), rshift(and($17,0x01000000),24) == 1 ? "true" : "false", rshift(and($17,0x00010000),8) == 1 ? "true" : "false"}'
    elif [ "`echo $i | grep udp`" ] ; then
        echo $i | awk '{printf "{ protocol:\"%s\", preNatClient:\"%s\", preNatServer:\"%s\", preNatClientPort:\"%s\",preNatServerPort:\"%s\", packets:\"%s\", bytes:\"%s\", postNatClient:\"%s\", postNatServer:\"%s\", postNatClientPort:\"%s\", postNatServerPort:\"%s\", qosPriority:\"%x\", bypassed:\"%s\", localTraffic:\"%s\",javaClass:\"com.untangle.uvm.SessionMonitorEntry\" }\n", toupper($1), $4, $5, $6, $7, $8, $9, $11, $10, $13, $12, rshift(and($16,0x00700000),20), rshift(and($16,0x01000000),24) == 1 ? "true" : "false", rshift(and($16,0x00010000),8) == 1 ? "true" : "false"}'
    else
        #don't print it
        first=0
    fi

done

echo "] }"
