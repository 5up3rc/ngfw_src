#! /bin/bash

. @PREFIX@/etc/default/untangle-vm

REG_KEY="$1"

if [ -n "$REG_KEY" ] ; then # boxes with physical activation keys
  echo $REG_KEY > $ACTIVATION_KEY_FILE

  if [[ $REG_KEY != $FAKE_KEY ]] ; then
    $KEY_VERIFICATION $REG_KEY 2> /dev/null
    VERIFY_RES="$?"
    if [ "$VERIFY_RES" -eq 1 ]; then
      echo "Key is invalid: $REG_KEY"
      rm -f $ACTIVATION_KEY_FILE
      exit 1
    elif [ "$VERIFY_RES" -ne 0 ]; then
      echo "Error validating registration.  Unable to continue."
      rm -f $ACTIVATION_KEY_FILE
      exit 2
    fi
  fi

  # If we get here, the key is good.
  echo "Key is valid"
fi

if [ ! -f $ACTIVATION_KEY_FILE -o ! -f $POPID_FILE ]; then
    # we need a popid
    echo "$NAME: about to create pop id" >> $UVM_WRAPPER_LOG
    output=`ruby @UVM_HOME@/bin/createpopid.rb 2>&1`
    if [ $? = 0 ] ; then
	echo "$NAME: created pop id" >> $UVM_WRAPPER_LOG
    else
	echo "$NAME: failed to create pop id; output was: '$output'"
	exit 1
    fi
fi

POPID=`cat $POPID_FILE`
# This next will fail if testing on development machines, which is "a good thing"
if [ -f "$SOURCES_LIST" ] && grep -q "$POPID" $SOURCES_LIST ; then # already taken care of
    true
else # dump the right source in the right place :)
    echo "Installing sources list"
    touch $SOURCES_LIST # so that we don't fail next line because of noclobber
    echo -e $DEFAULT_UNTANGLE_SOURCE | sed "s/$KEY_TEMPLATE/$POPID/" >> $SOURCES_LIST
    nohup apt-get update >& /dev/null &
fi

@UVM_HOME@/bin/utregister

exit 0
