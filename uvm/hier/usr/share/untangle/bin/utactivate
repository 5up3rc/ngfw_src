#! /bin/bash

. @PREFIX@/etc/default/untangle-vm

REG_KEY="$1"

if [ -n "$REG_KEY" ] ; then # the install wizard is calling us
  echo $REG_KEY > $ACTIVATION_KEY_FILE

  $KEY_VERIFICATION $REG_KEY 2> /dev/null
  VERIFY_RES="$?"
  if [ "$VERIFY_RES" -eq 1 ]; then
    echo "Key is invalid: $REG_KEY"
    rm -f $ACTIVATION_KEY_FILE
    exit 1
  elif [ "$VERIFY_RES" -ne 0 ]; then
    echo "Error validating registration.  Unable to continue."
    rm -f $ACTIVATION_KEY_FILE
    exit 2
  fi

  # If we get here, the key is good.
  echo "Key is valid"
else
  # we're being called from uvm.sh, and the popid is in the right
  # file already

  # This next will fail if testing on development machines, which is "a good thing"
  echo "Installing sources list"
  POPID=`cat $POPID_FILE`
  if [ -f "$SOURCES_LIST" ] && grep -q "$POPID" $SOURCES_LIST ; then # already taken care of
    true
  else # dump the right source in the right place :)
    touch $SOURCES_LIST # so that we don't fail next line because of noclobber
    echo -e $DEFAULT_UNTANGLE_SOURCE | sed "s/$KEY_TEMPLATE/$POPID/" >> $SOURCES_LIST
  fi
  apt-get update
fi
