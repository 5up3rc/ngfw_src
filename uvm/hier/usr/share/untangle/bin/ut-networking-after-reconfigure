#! /bin/bash

exec >> @UVM_LOG@/iptables.log 2>&1

REGDONE="@UVM_HOME@/conf/.regdone-flag"
REGINFO="@UVM_HOME@/conf/registration.info"

restartService() {
    local t_service=$1

    if [ ! -f /etc/init.d/${t_service} ];  then
        echo "[DEBUG:`date`] missing the service ${t_service}"
        return 0
    fi

    /etc/init.d/${t_service} restart
}

afterReconfigure() {

    # Gotta wait a little while for the bridge to reconfigure
    sleep 5

    t0=$(date +%s)
    restartService ntpdate
    t1=$(($(date +%s) + 10))
    if [ $t0 -gt $t1 ]; then
        echo "restarting alpaca because time went back"
        restartService untangle-net-alpaca
    fi
    restartService ntp-server
    restartService spamassassin
    restartService untangle-support-agent

    # remote support is enabled if sshd us running
    pidof sshd && restartService untangle-support-agent

    if [ -f "$REGINFO" ]; then
        if [ ! -f "$REGDONE" -o "$REGDONE" -ot "$REGINFO" ]; then
            @UVM_HOME@/bin/ut-register
        fi
    fi
}

## Execute these functions in a separate detached process, this way
## uvm doesn't wait around for us to run.
if [ $# -eq 0 ]; then
    ## Just append any arguments, they don't matter
    nohup bash @UVM_HOME@/networking/ut-networking-after-reconfigure 1 2 >> @UVM_LOG@/iptables.log 2>&1 &
else
    afterReconfigure
fi

exit 0
