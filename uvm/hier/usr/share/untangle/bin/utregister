#! /bin/bash

set -e

. @PREFIX@/etc/default/untangle-vm

REGISTRATION_DONE_FILE=@UVM_HOME@/.regdone
REGISTRATION_INFO_FILE=@UVM_HOME@/registration.info

/bin/rm -f "$REGISTRATION_DONE_FILE"

# this is unelegant, but as of now the registration info is written
# during the setup wizard, yet it doesn't have the actual key at that
# time, so this file always contains only 0s...
ACTIVATION_KEY=`cat $ACTIVATION_KEY_FILE`
perl -i -npe "s/$FAKE_KEY/$ACTIVATION_KEY/" $REGISTRATION_INFO_FILE

/usr/bin/curl --max-time 30 -o /dev/null -d "`cat $REGISTRATION_INFO_FILE`" "https://poptrack.untangle.com/register/custreg.php"
if [ "$?" -eq "0" ]; then
    /bin/touch "$REGISTRATION_DONE_FILE"
fi
