#!/usr/bin/python -u
import sys
import getopt
import signal
import os
sys.path.insert(0, '@PREFIX@/usr/lib/python2.6/')

import unittest2
import uvm
import untangle_tests
from   untangle_tests import *

for f in os.listdir('@PREFIX@/usr/lib/python2.6/untangle_tests'):
    if f.endswith('py'):
        (m, e) = os.path.splitext(f)
        __import__('untangle_tests.%s' % m)


class ArgumentParser(object):
    def __init__(self):
        self.hostIP = None
        self.hostUsername = None
        self.hostKeyFile = None
        self.verbosity = 2 # changed to default 2 because jcoffin
        self.logfile = '/tmp/unittest.log'
        self.fastfail = False
        self.repeat = False
        self.externalIntfId = 1
        self.internalIntfId = 2
        self.testsToRun = ['all']
        self.testsToExclude = []

    def set_hostIP( self, arg ):
        self.hostIP = arg

    def set_username( self, arg ):
        self.username = arg

    def set_keyfile( self, arg ):
        self.password = arg

    def set_logfile( self, arg ):
        self.logfile = arg

    def set_fastfail( self, arg ):
        self.fastfail = True

    def set_repeat( self, arg ):
        self.repeat = True

    def set_testsToRun( self, arg ):
        self.testsToRun = arg.split(",")

    def set_testsToExclude( self, arg ):
        self.testsToExclude = arg.split(",")

    def increase_verbosity( self, arg ):
        self.verbosity += 1

    def set_externalIntfId( self, arg ):
        self.externalIntfId = arg

    def set_internalIntfId( self, arg ):
        self.internalIntfId = arg

    def parse_args( self ):
        handlers = {
            '-h' : self.set_hostIP,
            '-u' : self.set_username,
            '-i' : self.set_keyfile,
            '-l' : self.set_logfile,
            '-v' : self.increase_verbosity,
            '-q' : self.set_fastfail,
            '-r' : self.set_repeat,
            '-t' : self.set_testsToRun,
            '-e' : self.set_testsToExclude,
            '-d' : self.set_externalIntfId,
            '-s' : self.set_internalIntfId
        }

        try:
            (optlist, args) = getopt.getopt(sys.argv[1:], 'h:u:i:l:d:s:t:e:vqr')
            for opt in optlist:
                handlers[opt[0]](opt[1])
            return args
        except getopt.GetoptError, exc:
            print exc
            printUsage()
            exit(1)

def printUsage():
    sys.stderr.write( """\
%s Usage:
  optional args:
    -h <host>  : client host IP (behind Untangle)
    -u <user>  : client host SSH login
    -i <file>  : client host SSH identity (key) file
    -l <file>  : log file
    -d <int>   : interface ID of the external interface (outside) default: 1
    -s <int>   : interface ID of the internal interface (client) default: 2
    -t <tests> : comma seperated list tests to run (default: "all") (exm: "webfilter,adblocker")
    -e <tests> : comma seperated list tests to EXCLUDE (default: "all") (exm: "webfilter,adblocker")
    -v         : verbose (can be specified more than one time)
    -q         : quit on first failure
    -r         : repeat test indefinitely (or until failure if -q is specified)
""" % sys.argv[0] )

def signal_handler(signal, frame):
        sys.exit(0)

def exit(code):
    global parser
    if (code != 0):
        print ""
        print "More details found in %s" % parser.logfile
    sys.exit(code)

def runTestSuite(suite):
    global parser
    global logfile
    print "== Testing %s ==" % suite.nodeName()
    tests = unittest2.TestLoader().loadTestsFromTestCase(suite)
    rc = 0
    skipc = 0  # number of skipped tests.
    total = len([t for t in tests])
    for test in tests:

        orig_stdout = sys.stdout
        orig_stderr = sys.stderr
        sys.stdout = logfile
        sys.stderr = logfile

        results = unittest2.TextTestRunner( stream=logfile, verbosity=parser.verbosity ).run( test )

        sys.stdout = orig_stdout
        sys.stderr = orig_stderr

        if (len(results.failures) > 0 or len(results.errors) > 0):
            print "Test FAILED  : %s " % test._testMethodName
            if (parser.fastfail):
                exit(1)
            else:
                rc += 1
        elif (len(results.skipped) > 0):
            print "Test skipped  : %s " % test._testMethodName
            skipc += 1
        else:
            print "Test success : %s " % test._testMethodName
    print "== Testing %s ==" % suite.nodeName()
    return rc, skipc, total

# Verify the test enviroment is setup correctly
def runTestEnvironmentTests():
    global parser
    global logfile
    suite = unittest2.TestLoader().loadTestsFromTestCase(TestEnvironmentTests)
    # results = unittest2.TextTestRunner( stream=logfile, verbosity=parser.verbosity ).run( suite )
    print "== Testing Test Environment =="
    for test in suite:
        results = unittest2.TextTestRunner( stream=logfile, verbosity=parser.verbosity ).run( test )
        if (len(results.failures) > 0 or len(results.errors) > 0):
            print "Test FAILED  : %s " % test._testMethodName
            print "The test enviroment is not configured correctly. Aborting..."
            exit(1) # always fast fail on basic test environment tests
        else:
            print "Test success : %s " % test._testMethodName
    print "== Testing Test Environment =="

signal.signal(signal.SIGINT, signal_handler)

parser = ArgumentParser()
script_args = parser.parse_args()
logfile = open(parser.logfile, 'w')

if (parser.hostIP != None):
    ClientControl.hostIP       = parser.hostIP
if (parser.hostUsername != None):
    ClientControl.hostUsername = parser.hostUsername
if (parser.hostKeyFile != None):
    ClientControl.hostKeyFile  = parser.hostKeyFile
ClientControl.verbosity   = parser.verbosity;
ClientControl.logfile = logfile;
ClientControl.interface = parser.internalIntfId;
ClientControl.interfaceExternal = parser.externalIntfId;

# if reports isn't installed, install and start it - it is required
reportsNode = None;
if (not uvm.Uvm().getUvmContext().nodeManager().isInstantiated('untangle-node-reporting')):
    print "== Installing untangle-node-reporting =="
    reportsNode = uvm.Uvm().getUvmContext().nodeManager().instantiate('untangle-node-reporting', None)

if ("environment" in parser.testsToRun or "all" in parser.testsToRun) and "environment" not in parser.testsToExclude:
    runTestEnvironmentTests()

if "all" in parser.testsToRun:
    parser.testsToRun = TestDict.allNodes()

# remove excluded tests
for testName in parser.testsToExclude:
    if testName in parser.testsToRun:
        parser.testsToRun.remove(testName)

while True:
    rc = 0
    total = 0
    skipc = 0

    for node in parser.testsToRun:
        if node == "environment":
            continue
        testClz = TestDict.test(node)
        if testClz == None:
           print "Unable to find tests for \"%s\" - skipping." % node
           continue
        errors, skipc, subTotal = runTestSuite(testClz)
        rc += errors
        total += subTotal

    if not parser.repeat:
        break

# if reports was added earlier, revert to original settings
if reportsNode != None:
    print "== UnInstalling untangle-node-reporting =="
    uvm.Uvm().getUvmContext().nodeManager().destroy( reportsNode.getNodeSettings()['id'] );

print ""
print "%s passed, %s skipped, %s failed" % (total-rc-skipc, skipc, rc)
print "More details found in %s" % parser.logfile

exit(rc)
