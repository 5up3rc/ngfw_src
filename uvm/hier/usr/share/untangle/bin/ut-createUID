#! /bin/bash

#
# This script creates a UID if there is not already one
# it also prepares the correct sources.list 
#

UID_FILE="@PREFIX@/usr/share/untangle/conf/uid"
NAME="$0"
UID_TEMPLATE=__UID__
if [[ $(cat /etc/debian_version) == 6* ]] ; then
  REPOSITORY=squeeze
else
  REPOSITORY=lenny
fi
CURRENT_STABLE=stable-9
DEFAULT_UNTANGLE_SOURCE="deb http://${UID_TEMPLATE}:untangle@updates.untangle.com/public/${REPOSITORY} ${CURRENT_STABLE} main premium upstream\ndeb http://${UID_TEMPLATE}:untangle@updates.untangle.com/public/${REPOSITORY} shovelhead-1 main premium upstream"

if [ ! -f $UID_FILE ]; then
    # we need a UID
    echo "`date` $NAME: creating UID..."
    output=`ruby @UVM_HOME@/bin/ut-createUID.rb 2>&1`
    if [ $? = 0 ] ; then
	    echo "`date` $NAME: created  UID."
    else
	    echo "`date` $NAME: failed to create UID; output was: '$output'"
	    exit 1
    fi
fi

MYUID=`cat $UID_FILE`

# add untangle sources to sources.list; remove the old ones
echo "`date` $NAME: Creating sources list..."
SOURCES_LIST=/etc/apt/sources.list.d/untangle.list
touch $SOURCES_LIST
perl -i -pe 's/.*untangle\.com.*//' $SOURCES_LIST
echo -e $DEFAULT_UNTANGLE_SOURCE | sed "s/$UID_TEMPLATE/$MYUID/" >> $SOURCES_LIST
echo "`date` $NAME: Created  sources list..."

exit 0
