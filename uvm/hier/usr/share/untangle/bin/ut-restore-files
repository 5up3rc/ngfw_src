#! /bin/bash

if [ "$USER" != "root" ] ; then
    echo "sudo $0 $*"
    exec sudo $0 $*
fi

. /etc/default/untangle-vm

INST_OPTS=" -o DPkg::Options::=--force-confnew --yes --force-yes --fix-broken "
UPGD_OPTS=" -o DPkg::Options::=--force-confnew --yes --force-yes --fix-broken "

restore_db()
{
    infile=$1

    dropdb -U postgres uvm >/dev/null 2>&1
    createuser -U postgres -dSR untangle 2>/dev/null
    createdb -O postgres -U postgres uvm >/dev/null 2>&1

    ## If the database is open, just drop all of the schemas inside of it.
    psql -U postgres uvm -c "DROP SCHEMA settings CASCADE"
    psql -U postgres uvm -c "DROP SCHEMA events CASCADE"
    psql -U postgres uvm -c "DROP SCHEMA reports CASCADE"

    # if confirm "Restore settings?"; then
    zcat $infile | psql -X -U postgres uvm >/dev/null 2>&1
    
    ## Reset the events schema, it is no longer valid.
    psql -U postgres -c "UPDATE settings.split_schema_ver SET events_version = NULL;" uvm  || true
    psql -U postgres -c "DROP SCHEMA IF EXISTS events CASCADE" uvm || true
    
    # fi
}

clean_dirs()
{
    rm -rf /usr/share/untangle/conf/openvpn
    rm -rf /etc/openvpn
    rm -f  /usr/share/untangle/conf/dirbackup.ldif
    rm -f  /usr/share/untangle/conf/alpaca-backup.uab
}

restore_packages()
{
    instfile=$1

    apt-get update 2>&1 | logger -f local2.info
    apt-get dist-upgrade $UPGD_OPTS 2>&1 | logger -f local2.info
    /etc/init.d/untangle-vm stop
    if [ -x /etc/init.d/untangle-reports ]; then
        /etc/init.d/untangle-reports stop
    fi

    cat $instfile | cut -d' ' -f1 | \
      xargs apt-get install $INST_OPTS 2>&1 | logger -f local2.info
}


if [ $# -lt 3 ] ; then
    echo "Usage: $0 dumpfile tarfile instfile"
fi

dumpfile=$1
tarfile=$2
instfile=$3

# stop the UVM, depending on circumstances may already be stopped
/etc/init.d/untangle-vm stop
if [ -x /etc/init.d/untangle-reports ]; then
    /etc/init.d/untangle-reports stop
fi

if [ -x /etc/init.d/untangle-cpd ]; then
    /etc/init.d/untangle-cpd stop
fi

if [ -x /etc/init.d/apache2 ]; then
    /etc/init.d/apache2 stop
fi

# restore the database
restore_db $dumpfile

# clean out stuff that restore would otherwise append to
clean_dirs

# restore the files, both system and the /usr/share/untangle important stuf
tar zxf $tarfile -C /

# update the things also kept in kernel (bug 5533)
hostname `cat /etc/hostname`

# restore the LDAP configuration
SLAPD_CONFIG=/etc/untangle-ldap/slapd.conf
SLAPD_LIB_DIR=/var/lib/untangle-ldap
UNTANGLE_SLAPD_CONFIG_DIR=/usr/share/untangle-ldap-server
if [ -f $SLAPD_CONFIG -a -f /usr/share/untangle/conf/dirbackup.ldif ]; then
    /etc/init.d/untangle-slapd stop
    rm -rf ${SLAPD_LIB_DIR}
    mkdir -p ${SLAPD_LIB_DIR}
    cp ${UNTANGLE_SLAPD_CONFIG_DIR}/DB_CONFIG ${SLAPD_LIB_DIR}/DB_CONFIG
    slapadd -f $SLAPD_CONFIG -l /usr/share/untangle/conf/dirbackup.ldif
    slapindex -f $SLAPD_CONFIG
    /etc/init.d/untangle-slapd start
fi

# try to download needed files, this may fail because the network settings may not be correct
restore_packages $instfile

## Qualified and unqualified hostname (hostname may not be set yet)
host_string=`awk '{ hostname = $0 ; sub ( /\..*/, "", hostname ) ; print $0 " " hostname }' /etc/hostname`

## Rewrite the /etc/hosts file, the alpaca uses hostname.marker.untangle.com to update the hostname
## entry for local users.
cat <<EOF > /etc/hosts
# AUTOGENERATED BY UNTANGLE DO NOT MODIFY MANUALLY

127.0.0.1  localhost localhost.localdomain
127.0.0.1  ${host_string} hostname.marker.untangle.com

# The following lines are desirable for IPv6 capable hosts
# (added automatically by netbase upgrade)

::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
ff02::3 ip6-allhosts
EOF

# Restore the network settings
[ -x /usr/share/untangle-net-alpaca/scripts/restore -a -f /usr/share/untangle/conf/alpaca-backup.uab ] && /usr/share/untangle-net-alpaca/scripts/restore /usr/share/untangle/conf/alpaca-backup.uab

# try again just in case these network settings are "better" than the previous
restore_packages $instfile

# Restart apache
/etc/init.d/apache2 restart

# start the UVM, depending on circumstances (menu driven restore) may need to be restopped
/etc/init.d/untangle-vm start > /dev/null 2>&1

if [ -x /etc/init.d/untangle-reports ]; then
    /etc/init.d/untangle-reports start
fi

# Inform the UVM that the DB settings have changed, give it a chance to write out config files.
/usr/bin/rush -e "Untangle::RemoteUvmContext.syncConfigFiles()"
