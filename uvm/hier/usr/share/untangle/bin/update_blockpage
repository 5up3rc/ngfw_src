#!/bin/dash

get_available_version()
{
    ## Use the DNS system to check the current version.
    host -t txt update-1.untangle.com | awk -v version=unknown '/descriptive text "[0-9]+"$/ { gsub( ".* descriptive text \"", "" ) ; gsub( "\"$", "" ) ; version=$0 } ; END { print version }'
}

get_current_version()
{
    if [ ! -f ${version_file} ]; then
        echo "0"
        return
    fi
    
    cat ${version_file}
}

requires_update()
{
    local t_current_version
    local t_available_version
    local t_current_time
    
    t_current_version=$1
    t_available_version=$2
    t_current_time=`date +"%s"`
    
    if [ "${t_available_version}" = "unknown" ]; then
        echo "[`date`] Unable to determine the available version, cancelling."
        return 0
    fi
    
    if [ "${t_current_version}" -gt "${t_current_time}" ]; then
        echo "[`date`] The current version is in the future, forcing a refresh."
        return 1
    fi

    if [ "${t_current_version}" -ge "${t_available_version}" ]; then
        echo "[`date`] The current version ${t_current_version} is up to date."
        return 0
    fi


    echo "[`date`] The current version (${t_current_version}) is not up to date (${t_available_version})."
    return 1
}

download_update()
{
    local t_output
    t_output=$1

    curl http://www.untangle.com/download/patches/blockpage.tar.gz > ${t_output}
}

install_update()
{
    local t_archive
    t_archive=$1

    ## Expand the archive into the blockpage directory, only expand files in that directory.
    tar -C / -zxf ${t_archive} usr/share/untangle/web/blockpage
    
    echo "${available_version}" > ${version_file}
}

## For testing, just source from another a test script and try out the functions.
if [ `basename "$0"` = "update_blockpage" ] ; then
    set -e
    version_file="/usr/share/untangle/web/blockpage/.version.txt"
    current_version=`get_current_version`
    available_version=`get_available_version`
    
    requires_update ${current_version} ${available_version} || {
        temp_file=`mktemp`
        download_update ${temp_file}
        install_update ${temp_file}
    }
fi

