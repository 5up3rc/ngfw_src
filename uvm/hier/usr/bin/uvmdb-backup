#! /bin/bash

if [ $# -eq 0 ]; then
    echo "usage; $0 [ usb | local ] (out dir)"
    exit 1
fi

USB_MOUNT_POINT=/mnt/usb-mv-mount

lookup_usb_device()
{
    udevinfo --export | awk '/^N:/ { device="/dev/"$2 ; is_usb=0 ; is_disk=0; is_partition=0 }
/ID_BUS=usb/ { is_usb=1  }
/ID_TYPE=disk/ { is_disk=1 }
/ID_FS_USAGE=filesystem/ { is_partition=1 }
/^$/ { if ( is_usb == 1 && is_disk == 1 ) { print device ; is_usb=0 ; is_disk=0 ; if ( is_partition == 1 ) exit }}
' | tail -n 1
}

method=$1

outdir=@UVM_DUMP@
if [ $# -eq 2 ]; then
  outdir=$2
fi

mkdir -p $outdir

case $method in
    usb)
        usb_device=`lookup_usb_device`

        if [ -z "${usb_device}" ]; then
            exit -1
        fi

        mkdir -p ${USB_MOUNT_POINT}

        ## ignore errors
        umount ${USB_MOUNT_POINT} || true
        mount ${usb_device} ${USB_MOUNT_POINT}
        outdir=${USB_MOUNT_POINT}
        ;;
#    local)
#        outdir=@UVM_DUMP@
#        ;;
esac

datestamp=$(date '+%Y%m%d%H%M')

pg_dump -U postgres -n settings uvm | gzip > $outdir/uvmdb-$datestamp.gz

[ $? -eq 0 ] || exit 1

[ -x /usr/sbin/slapcat ] && /usr/sbin/slapcat -f /etc/untangle-ldap/slapd.conf -l @PREFIX@/usr/share/untangle/conf/dirbackup.ldif

## Run the script to backup the alpaca
[ -x  /usr/share/untangle-net-alpaca/scripts/backup ] && /usr/share/untangle-net-alpaca/scripts/backup @PREFIX@/usr/share/untangle/conf/alpaca-backup.uab "UVM Backup"

tar zcf $outdir/files-$datestamp.tar.gz --ignore-failed-read -C @PREFIX@/ \
        etc/hostname \
        etc/network/interfaces \
        etc/openvpn \
        etc/resolv.conf \
	etc/apache2/ssl \
        usr/share/untangle/conf/argon.properties \
        usr/share/untangle/conf/keystore \
        usr/share/untangle/conf/uvm.networking.properties \
        usr/share/untangle/conf/networking.sh \
        usr/share/untangle/conf/openvpn/misc \
        usr/share/untangle/conf/openvpn/pki \
        usr/share/untangle/conf/dirbackup.ldif \
        usr/share/untangle/conf/alpaca-backup.uab

# Tar exits with non-zero when some files don't exist, which can happen.
# [ $? -eq 0 ] || exit 1

@UVM_HOME@/bin/mkg installed > $outdir/installed-$datestamp

[ $? -eq 0 ] || exit 1

if [ $method = "usb" ]; then
    umount ${USB_MOUNT_POINT}
fi
