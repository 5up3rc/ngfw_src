# UVM server settings -*-sh-*-

## Simply function for taking a string, trim surround space, and the convert
## space separators to the token string. eg join_string " a b c " ";" -> "a;b;c"
join_string() {
    echo $1 | sed -e 's/^ *//g' -e 's/ *$//g' -e "s/ \\+/$2/g"
}

source @PREFIX@/etc/default/untangle-babysitter
source @PREFIX@/etc/default/untangle-activation

DEFAULT_DMZ="eth2"

UVM_LOGDIR=@PREFIX@/var/log/uvm
UVM_RUNDIR=@PREFIX@/var/run
UVM_RESTART_PIDFILE=$UVM_RUNDIR/uvm-restart.pid
UVM_REBOOT_PIDFILE=$UVM_RUNDIR/uvm-reboot.pid
UVM_CONSOLE_LOG=${UVM_CONSOLE_LOG:-$UVM_LOGDIR/console.log}
UVM_WRAPPER_LOG=$UVM_LOGDIR/wrapper.log
UVM_GC_LOG=$UVM_LOGDIR/gc.log
UVM_CMD=@PREFIX@/usr/bin/uvm.sh
UVM_USER=root
## Defaults to 10000 in the code, set here if you want something else
UVM_SESSION_LIMIT=""

# Use the following to configure your local installation.
UVM_ARGS=""

# postgresql stuff
PG_VERSION=`dpkg -l postgresql | awk '/^ii/ { gsub(/\..-.*/, "", $3) ; print $3 }'`
if [[ "$PG_VERSION" == 7* ]] ; then
    PGDATA=${POSTGRES_DATA:-/var/lib/postgres/data}
    PGSERVICE="postgresql"
    PG_DAEMON_NAME="postmaster"
    PG_CREATEUSER_OPTIONS="-dA"
else
    PGDATA=${POSTGRES_DATA:-/var/lib/postgresql/${PG_VERSION}/main}
    PGSERVICE="postgresql-${PG_VERSION}"
    PG_DAEMON_NAME="postgres"
    PG_CREATEUSER_OPTIONS="-dSR"
fi

# cli stuff
CLI_SERVER_HOME=/usr/share/untangle-cli-server/src
# JRUBY_HOME=/usr/lib/jruby1.0

## For testing uncomment if you want to generate /etc/network/interfaces files.
# UVM_ENABLE_NETWORK_CFG="anything"

if [ "x${USER}" = "x" -o "x${USER}" = "xroot" ]; then
        UVM_NICENESS=0
else
        UVM_NICENESS=0
fi

# if in the build, disable network configuration by default
if [ "x" != "x@PREFIX@" ]  && [ -z "${UVM_ENABLE_NETWORK_CFG}" ] ; then
    UVM_ARGS="${UVM_ARGS} -Dbunnicula.devel.nonetworking=true"
fi

## Append the session limit if it is set
if [ -n "${UVM_SESSION_LIMIT}" ]; then
    UVM_ARGS="${UVM_ARGS} -Dargon.sessionlimit=${UVM_SESSION_LIMIT}"
fi

#
# Profiling
#
PROFILE_UVM_YJP=${PROFILE_UVM_YJP=$:-no}
export PROFILE_UVM_YJP

# Use the Throughput or Concurrent-Low-Pause garbage collector?
# We normally want to use the Concurrent collector as it gives the lowest possible pause
# times.
USE_THROUGHPUT_COLLECTOR=no
if [ "x$PROFILE_UVM_YJP" = "xyes" ] ; then
    USE_THROUGHPUT_COLLECTOR=yes
fi

#
# Heap monitor thread
#
## Enable the heap monitor.
UVM_ARGS="${UVM_ARGS} -Dcom.untangle.uvm.memmonitor.enabled=true"

## Rate, kilobytes/second to start dumping stack traces.
#UVM_ARGS="${UVM_ARGS} -Dcom.untangle.uvm.memmonitor.rate=$((3 * 1024)"

## required minimum to start dumping memory (even if rate exceeds rate)
#UVM_ARGS="${UVM_ARGS} -Dcom.untangle.uvm.memmonitor.min=$(( 100 * 1024 ))"

## Level at which to just dump memory regardless of the rate
#UVM_ARGS="${UVM_ARGS} -Dcom.untangle.uvm.memmonitor.level=$(( 310 * 1024 ))"

## Poll frequence in milliseconds
#UVM_ARGS="${UVM_ARGS} -Dcom.untangle.uvm.memmonitor.poll=500"

## Minimum number of milliseconds in between dumping two thread dumps
#UVM_ARGS="${UVM_ARGS} -Dcom.untangle.uvm.memmonitor.interval=3000"

## Name of the file where the log should go, if unspecified, this goes to console.log
#UVM_ARGS="${UVM_ARGS} -Dcom.untangle.uvm.memmonitor.file=heapmonitor.log"

## Lifetime for positive phonebook lookups (millis)
#UVM_ARGS="${UVM_ARGS} -Dcom.untangle.uvm.user.phonebook.lifetime=300000"

## Lifetime for succesful wmi lookups (millis)
#UVM_ARGS="${UVM_ARGS} -Dcom.untangle.uvm.user.wmi.lifetime=240000"

## Lifetime for unsuccesful wmi lookups (millis)
#UVM_ARGS="${UVM_ARGS} -Dcom.untangle.uvm.user.wmi.negativelifetime=600000"

#
# JAVA options
#
DEFAULT_JAVA_HOME=@DEFAULT_JAVA6_HOME@

# NOTE: this setting is required
JAVA_HOME=${JAVA_HOME:-${DEFAULT_JAVA_HOME}}
export JAVA_HOME

PATH=${JAVA_HOME}/bin:${PATH}
export PATH

# Could use HOSTTYPE, but it's not as standard as uname -m
MACHARCH=`uname -m`

# The maximum heap/virtual sizes depend on the memory available
MEM=$(awk '/MemTotal/ { print $2 }' < /proc/meminfo)
if [ $MEM -gt 3900000 ] ; then
    if [ $MACHARCH = 'x86_64' ]; then
    MAX_HEAP_SIZE=1200m
    MAX_VIRTUAL_SIZE=5500000
    MAX_UCB_DB_MEG=150
    [ -z "$UVM_SESSION_LIMIT" ] && UVM_SESSION_LIMIT=30000
    else
    MAX_HEAP_SIZE=960m
    MAX_VIRTUAL_SIZE=2500000
    MAX_UCB_DB_MEG=120
    fi
elif [ $MEM -gt 1900000 ] ; then
    if [ $MACHARCH = 'x86_64' ]; then
    MAX_HEAP_SIZE=800m
    MAX_VIRTUAL_SIZE=3500000
    MAX_UCB_DB_MEG=100
    [ -z "$UVM_SESSION_LIMIT" ] && UVM_SESSION_LIMIT=20000
    else
    MAX_HEAP_SIZE=640m
    MAX_VIRTUAL_SIZE=1500000
    MAX_UCB_DB_MEG=80
    fi
elif [ $MEM -gt 900000 ] ; then
    if [ $MACHARCH = 'x86_64' ]; then
    MAX_HEAP_SIZE=380m
    MAX_VIRTUAL_SIZE=1950000
    MAX_UCB_DB_MEG=48
    else
    MAX_HEAP_SIZE=320m
    MAX_VIRTUAL_SIZE=950000
    MAX_UCB_DB_MEG=32
    fi
else
    if [ $MACHARCH = 'x86_64' ]; then
    MAX_HEAP_SIZE=260m
    MAX_VIRTUAL_SIZE=1500000
    MAX_UCB_DB_MEG=24
  else
    MAX_HEAP_SIZE=220m
    MAX_VIRTUAL_SIZE=800000
    MAX_UCB_DB_MEG=20
    fi
fi

## Limit Berkeley DB caching to 5% of java heap
UVM_ARGS="${UVM_ARGS} -Dje.maxMemory=${MAX_UCB_DB_MEG}"

## Reduce DNS caching to minimal (30 seconds).  Don't eliminate completely
## to limit impact of multiple lookups in a short period.
UVM_ARGS="${UVM_ARGS} -Dnetworkaddress.cache.ttl=30 -Dsun.net.inetaddr.ttl=30 -Dnetworkaddress.cache.negative.ttl=10"

if [ "x$USE_THROUGHPUT_COLLECTOR" = "xyes" ] ; then
# Goals: 85% throughput (don't set maxpausegcmillis here, you'll regret it)
    JAVA_OPTS_SUN="-XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseParallelGC -XX:GCTimeRatio=6"
else
    JAVA_OPTS_SUN="-XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseConcMarkSweepGC -XX:+CMSIncrementalMode -XX:+CMSIncrementalPacing -XX:CMSIncrementalDutyCycleMin=0 -XX:CMSIncrementalDutyCycle=10 -XX:+UseParNewGC -XX:NewRatio=4"
fi
JAVA_OPTS_BEA="-Xgcpause -Xgcprio:pausetime"
# Java Options:
#  Minimum at 128m so we don't blow out smaller (512MB) machines
#  Maximum at 320m so we leave a lot of space for stacks but still have enough for 10,000 sessions
#  Stack size 96k which is small enough but still works
JAVA_OPTS_COMMON="-verbose:gc -Xloggc:$UVM_GC_LOG -Xms128m -Xmx${MAX_HEAP_SIZE} -server"

if [ $MACHARCH != 'x86_64' ]; then
    JAVA_OPTS_COMMON="-Xss96k $JAVA_OPTS_COMMON"
    JAVAWS=${JAVA_HOME}/bin/javaws
else
    JAVA_OPTS_COMMON="-Xss192k $JAVA_OPTS_COMMON"
    JAVAWS=/usr/lib/jvm/ia32-java-6-sun/bin/javaws
fi
export JAVAWS

if [ "x" != "x@PREFIX@" ] ; then
    JAVA_OPTS_COMMON="-ea $JAVA_OPTS_COMMON"
fi

if [ -f $JAVA_HOME/bin/console ] ; then
    JAVA_OPTS="$JAVA_OPTS_COMMON $JAVA_OPTS_BEA" #   BEA
else
    JAVA_OPTS="$JAVA_OPTS_COMMON $JAVA_OPTS_SUN" #   SUN
fi

export JAVA_OPTS
