#!/bin/dash

## Auto Generated on 2016-10-10 10:49:17.845248
## DO NOT EDIT. Changes will be overwritten.

TABLE_SIZE=65535
LIST_SIZE=50
MAX_RATE=30


iptables_debug_onerror()
{
    # Ignore -N errors
    /sbin/iptables "$@" || {
        [ "${3}x" != "-Nx" ] && echo "[`date`] Failed: /sbin/iptables $@"
    }

    true
}

if [ -z "${IPTABLES}" ] ; then
    IPTABLES="iptables_debug_onerror"
fi

${IPTABLES} -t filter -N shield >/dev/null 2>&1
${IPTABLES} -t filter -F shield

${IPTABLES} -t filter -N shield-rules >/dev/null 2>&1
${IPTABLES} -t filter -F shield-rules

${IPTABLES} -t filter -N shield-process >/dev/null 2>&1
${IPTABLES} -t filter -F shield-process

${IPTABLES} -t filter -N shield-block >/dev/null 2>&1
${IPTABLES} -t filter -F shield-block

modprobe -r xt_recent
modprobe xt_recent ip_list_tot=${TABLE_SIZE} ip_pkt_list_tot=${LIST_SIZE}


    
${IPTABLES} -D FORWARD -t filter -p udp -m comment --comment "Shield scan" -m state --state NEW -j shield >/dev/null 2>&1
${IPTABLES} -A FORWARD -t filter -p udp -m comment --comment "Shield scan" -m state --state NEW -j shield
${IPTABLES} -D FORWARD -t filter -p tcp -m comment --comment "Shield scan" -m state --state NEW -j shield >/dev/null 2>&1
${IPTABLES} -A FORWARD -t filter -p tcp -m comment --comment "Shield scan" -m state --state NEW -j shield

${IPTABLES} -t filter -A shield -m comment --comment "Only process new sessions" -m state ! --state NEW -j RETURN
${IPTABLES} -t filter -A shield -m comment --comment "Only process scanned sessions" -m connmark --mark 0x01000000/0x01000000 -j RETURN
${IPTABLES} -t filter -A shield -m comment --comment "Process shield rules" -j shield-rules

${IPTABLES} -t filter -A shield-process -m comment --comment "Block sessions over limit" -m recent --name shield --rcheck --seconds 1 --reap --hitcount ${MAX_RATE} -j shield-block
${IPTABLES} -t filter -A shield-process -m comment --comment "Update shield table" -m recent --name shield --set -j RETURN

${IPTABLES} -t filter -A shield-block -m comment --comment "Log the shield_blocked" -j NFLOG --nflog-prefix "shield_blocked"
${IPTABLES} -t filter -A shield-block -m comment --comment "Drop the packet" -m recent --name shield --rcheck --seconds 1 --hitcount ${MAX_RATE} -j DROP

# Shield Rules


${IPTABLES} -t filter -A shield-rules -m comment --comment "No rules matched - process session normally" -j shield-process
        
