<?xml version="1.0"?>

<!--
Copyright (c) 2004, 2005 Metavize Inc.
All rights reserved.

This software is the confidential and proprietary information of
Metavize Inc. ("Confidential Information").  You shall
not disclose such Confidential Information.

$Id: build.xml,v 1.22 2005/03/25 04:00:30 jdi Exp $
-->

<project name="gui" basedir="." default="all">

  <import file="../buildtools/buildmagic.xml"/>

  <!-- main targets -->
  <target name="pkg.gensrc"  depends="gensrc.servlets, gensrc.version"/>
  <target name="pkg.compile" depends="compile.gui"/>
  <target name="pkg.jar"     depends="jar.gui, jar.servlets"/>
  <target name="pkg.install" depends="install.hier, install.gui, install.servlets, install.webstart"/>
  <target name="pkg.clean"   depends="clean.nuke"/>


  <property name="build.gui" value="${build.root}/gui"/>

  <target name="gensrc.version">
    <mkdir dir="${build.gensrc}/com/metavize/gui/util"/>
    <copy file="resources/Version.java" toFile="${build.gensrc}/com/metavize/gui/util/Version.java" overwrite="true"/>
    <exec executable="/bin/sh" failonerror="true">
      <arg value="-c"/>
      <arg value="/bin/sed s/\&quot;VERSION\&quot;/\&quot;`cat ../../PUBVERSION`\&quot;/g -i ./output/gensrc/com/metavize/gui/util/Version.java"/>
    </exec>
  </target>

  <target name="gensrc.servlets">
    <!-- Do the jsp's so we don't need a JDK at runtime -->
    <echo message="uriroot is ${src.hier}/${suffix.mvvm.webstart}"/>
    <!-- We need an explicit list of files since the JspC task only finds *.jsp -->
    <!-- We need fork to avoid class duplication bug in ant -->
    <java classname="org.apache.jasper.JspC"
          fork="true"
          failonerror="true">
      <arg line="-d ${build.gensrc}"/>
      <arg line="-p com.metavize.jsp"/>
      <arg line="-webinc ${build.gensrc}/web-fragment.xml"/>
      <arg line="-uriroot ${src.hier}/${suffix.mvvm.webstart}/"/>
      <arg value="index.jsp"/>
      <arg value="gui.jnlp"/>
      <arg value="gui-local.jnlp"/>
      <classpath refid="mvvm.thirdparty.classpath"/>
      <classpath refid="tomcat.classpath"/>
    </java>
    <echo message="Adding JSP servlet mappings to web.xml"/>
    <loadfile property="generated-web.xml" srcFile="${build.gensrc}/web-fragment.xml"/>
    <copy file="${src.hier}/${suffix.mvvm.webstart}/WEB-INF/web.xml" toFile="${dist.mvvm.webstart}/WEB-INF/web.xml" overwrite="true">
      <filterset>
        <filter token="JSP_PRE_COMPILED_SERVLETS" value="${generated-web.xml}"/>
      </filterset>
    </copy>
  </target>

  <target name="compile.gui">
    <mkdir dir="${build.gui}"/>

    <exec executable="${buildtool.base}/dependset.sh">
      <arg value="${build.gui}"/>
      <arg value="${build.depcache}/gui.patternset"/>
    </exec>

    <depend srcdir="${src.main}" destdir="${build.gui}"
            cache="${build.depcache}/gui" closure="yes">
      <patternset includesfile="${build.depcache}/gui.patternset"/>
    </depend>

    <javac destdir="${build.gui}"
           debug="on"
           optimize="false"
           deprecation="on"
           source="1.5"
       target="1.5"
           includeAntRuntime="false">

      <classpath refid="mvvm-client.classpath"/>

      <classpath refid="jfreechart.gui.classpath"/>
      <classpath refid="netbeans.classpath"/>
      <classpath refid="kunststoff.classpath"/>
      <classpath refid="jnlp.classpath"/>
      <classpath refid="tomcat.classpath"/>

      <src path="${build.gensrc}"/>
      <src path="${src.main}"/>
    </javac>

  </target>

  <target name="jar.gui" depends="compile.gui">
    <jar destfile="${build.jar}/gui.jar" index="yes">
      <fileset dir="${build.gui}">
        <exclude name="com/metavize/jsp/**"/>
      </fileset>
      <fileset dir="${src.main}">
        <include name="**/*png"/>
        <include name="**/*gif"/>
        <include name="**/*jpg"/>
      </fileset>
      <fileset dir="../mvvm/resources">
        <include name="EvalLicense.txt"/>
      </fileset>
    </jar>
  </target>

  <target name="jar.servlets" depends="compile.gui">
    <jar destfile="${build.jar}/servlets.jar" index="yes">
      <fileset dir="${build.gui}">
        <include name="com/metavize/jsp/**"/>
      </fileset>
    </jar>
  </target>

  <target name="install.gui" depends="jar.gui">
    <copy file="${build.jar}/gui.jar" todir="${dist.mvvm.lib}"/>
  </target>

  <target name="install.servlets" depends="jar.servlets">
    <copy file="${build.jar}/servlets.jar" todir="${dist.mvvm.webstart}/WEB-INF/lib"/>
  </target>

  <target name="install.hier">
    <copy todir="${dist.mvvm.webstart}/WEB-INF/lib">
      <fileset refid="mvvm-client.jarset"/>
      <fileset refid="jnlp-servlet.jarset"/>
    </copy>

    <!-- filtered files -->
    <copy todir="${build.dist}" filtering="true">
      <fileset dir="${src.hier}">
        <exclude name="**/*.gif"/>
        <exclude name="**/*.ico"/>
        <exclude name="**/*.jpg"/>
        <exclude name="**/*.png"/>
      </fileset>
    </copy>

    <!-- binary files -->
    <copy todir="${build.dist}" filtering="false">
      <fileset dir="${src.hier}">
        <include name="**/*.gif"/>
        <exclude name="**/*.ico"/>
        <include name="**/*.jpg"/>
        <include name="**/*.png"/>
      </fileset>
    </copy>

    <chmod perm="ugo+rx">
      <fileset dir="${build.dist}/usr/bin"/>
    </chmod>
  </target>

  <target name="install.webstart" depends="jar.gui">

    <copy todir="${dist.mvvm.webstart}" flatten="true">
      <fileset refid="gui.jarset"/>
      <fileset refid="hibernate.client.jarset"/>
      <fileset refid="hibernate.gui.jarset"/>
      <fileset refid="jfreechart.gui.jarset"/>
      <fileset refid="jnlp.jarset"/>
      <fileset refid="kunststoff.jarset"/>
      <fileset refid="log4j.jarset"/>
      <fileset refid="mvvm-client.jarset"/>
      <fileset refid="netbeans.jarset"/>
    </copy>

    <!-- First must repack to "normalize" the jar file (Thanks Sun!) -->
    <if> <isset property="use-pack200"/> <then>
      <foreach target="repack.200" param="jarfile" inheritall="true"
               parallel="false">
        <fileset dir="${dist.mvvm.webstart}">
          <include name="*.jar"/>
        </fileset>
      </foreach>
      </then></if>

    <signjar keystore="./keystore" alias="key"
             storepass="0x7a0f4b2f2b0560fa" lazy="true">
      <fileset dir="${dist.mvvm.webstart}">
        <include name="*.jar"/>
      </fileset>
    </signjar>

    <!-- Now we can do the real packing -->
    <if> <isset property="use-pack200"/> <then>
      <foreach target="pack.200" param="jarfile" inheritall="true"
               parallel="false">
        <fileset dir="${dist.mvvm.webstart}">
          <include name="*.jar"/>
        </fileset>
      </foreach>
      </then></if>

  </target> <!-- install.webstart -->

  <!-- Used in install.webstart target only -->
  <target name="repack.200">
    <pack200 src="${jarfile}"
             destfile="${jarfile}.pack"/>
    <unpack200 src="${jarfile}.pack"
               dest="${jarfile}"/>
    <delete file="${jarfile}.pack"/>
  </target>

  <!-- Used in install.webstart target only -->
  <target name="pack.200">
    <pack200 src="${jarfile}"
             destfile="${jarfile}.pack.gz"
             gzipoutput="true"/>
  </target>

  <!-- Javadoc target -->
  <target name="jdoc" depends="pkg.jar">
    <!-- "func.jdoc" defined in "common-targets.xml" -->
    <antcall target="func.jdoc">
      <param name="jdoc.src" value="${src.main}"/>
    </antcall>
  </target>

  <!--
    Copy source files to ${jdoc.bigtree.src}
    for inclusion in big JavaDoc generation
  -->
  <target name="bigjdoc">
    <copydir src="${src.main}"
      dest="${jdoc.bigtree.src}"
      includes="**/*.java"
      excludes="**/Test.java"
      forceoverwrite="true"/>
  </target>

</project>
