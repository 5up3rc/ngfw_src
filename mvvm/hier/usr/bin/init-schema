#!/bin/sh

PSQL="psql -U metavize mvvm"

if [ $# = 0 ]; then
    echo "usage: $0 component"
    exit 1
fi

component=$1
schema_dir=@MVVM_SCHEMA@/$component

latest_ver=$(ls $schema_dir/schema-*.sql | sed 's/^.*schema-\([0-9]\+\).sql/\1/' | sort -n -r | head -n1)

echo $latest_ver

psql -e -f $schema_dir/schema-$latest_ver.sql -U metavize mvvm >> @MVVM_LOG@/schema.log 2>&1

echo "CREATE TABLE schema_ver (component varchar(64), version int4);" | $PSQL
echo "DELETE FROM schema_ver WHERE component = '$component';" | $PSQL
echo "INSERT INTO schema_ver VALUES ('$component', $latest_ver);" | $PSQL
