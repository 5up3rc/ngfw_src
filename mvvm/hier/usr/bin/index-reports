#!/bin/sh

main_index=@MVVM_REPORTS@/current/$1
index=$1
mail_reports_arguments_daily=@PREFIX@/usr/bin/mail_reports_arguments_daily.txt
mail_reports_arguments_weekly=@PREFIX@/usr/bin/mail_reports_arguments_weekly.txt
mail_reports_arguments_monthly=@PREFIX@/usr/bin/mail_reports_arguments_monthly.txt
generate_email_index=$2

if [ "$generate_email_index" != false ]; then
web_base=http://metavize.com/mail_blast
else
web_base=.
fi

cd @MVVM_REPORTS@/current

tran_list=@MVVM_REPORTS@/current/*


# generate email argument list
if [ "$generate_email_index" = daily ]; then
mail_reports_arguments="$mail_reports_arguments_daily"
fi

if [ "$generate_email_index" = weekly ]; then
mail_reports_arguments="$mail_reports_arguments_weekly"
fi

if [ "$generate_email_index" = monthly ]; then
mail_reports_arguments="$mail_reports_arguments_monthly"
fi

if [ "$generate_email_index" != false ]; then
    rm -f $mail_reports_arguments
    touch $mail_reports_arguments
fi

if [ "$generate_email_index" != false ]; then
    styles=styles_email.css
    echo "./$index" >> $mail_reports_arguments
    echo "./$styles" >> $mail_reports_arguments
    find ./images/* -type f >> $mail_reports_arguments
else
    styles=styles.css
fi

generate_page ()
{
cat > $main_index <<EOF

<html xmlns="http://www.w3.org/1999/xhtml">

  <!-- HEADING -->
  <head>
    <title>Metavize EdgeReport</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
    <link rel="stylesheet" type="text/css" href="./$styles"/>
    <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.ico"/>
  </head>

  <!--BRUSHED METAL PAGE BACKGROUND -->
  <body>
    <center>
      <table border="0" cellpadding="0" cellspacing="0" width="904">

        <!-- TOP THIRD -->
        <tr> 
          <td id="table_main_top_left">
            <img src="$web_base/images/spacer.gif" alt=" " width="23" height="23"/>
          </td>
          <td width="100%" id="table_main_top">
            <img src="$web_base/images/spacer.gif" alt=" " width="1" height="1"/>
          </td>
          <td id="table_main_top_right">
            <img src="$web_base/images/spacer.gif" alt=" " width="23" height="23"/>
          </td>
        </tr>
        <!-- END TOP THIRD -->

        <!-- MIDDLE THIRD -->
        <tr> 
          <td id="table_main_left">
            <img src="$web_base/images/spacer.gif" alt=" " width="1" height="1"/>
          </td>
          <td id="table_main_center">
            <table>
              <tr>
              <td valign="middle">
                <img src="$web_base/images/logo_no_text_shiny_96x96.gif" alt="Metavize logo" width="96" height="96"/>
              </td>
              <td style="padding: 0px 0px 0px 10px" valign="middle">
EOF

if [ "$generate_email_index" = false ]; then
cat >> $main_index <<EOF
                <span class="page_header_title">Metavize EdgeReport</span>
EOF
else
if [ "$generate_email_index" = daily ]; then
cat >> $main_index <<EOF
                <span class="page_header_title">Metavize EdgeReport   (Daily via email)</span>
EOF
fi

if [ "$generate_email_index" = weekly ]; then
cat >> $main_index <<EOF
                <span class="page_header_title">Metavize EdgeReport   (Weekly via email)</span>
EOF
fi

if [ "$generate_email_index" = monthly ]; then
cat >> $main_index <<EOF
                <span class="page_header_title">Metavize EdgeReport   (Monthly via email)</span>
EOF
fi
fi

cat >> $main_index <<EOF
              </td>
              </tr>
            </table>
          </td>
          <td id="table_main_right">
            <img src="$web_base/images/spacer.gif" alt=" " width="1" height="1"/>
          </td>
        </tr>
        <!-- END MIDDLE THIRD -->
EOF

generate_content_area

cat >> $main_index <<EOF

        <!-- BOTTOM THIRD -->
        <tr>
          <td id="table_main_bottom_left">
            <img src="$web_base/images/spacer.gif" alt=" " width="23" height="23"/>
          </td>
          <td id="table_main_bottom">
            <img src="$web_base/images/spacer.gif" alt=" " width="1" height="1"/>
          </td>
          <td id="table_main_bottom_right">
            <img src="$web_base/images/spacer.gif" alt=" " width="23" height="23"/>
          </td>
        </tr>
        <!-- END BOTTOM THIRD -->

      </table>
    </center>

  </body>
  <!-- END BRUSHED METAL PAGE BACKGROUND -->

</html>

EOF
}

generate_content_area ()
{
cat >> $main_index <<EOF
        <!-- CONTENT AREA -->
        <tr>
          <td id="table_main_left"></td>

          <!-- CENTER CELL -->
          <td id="table_main_center" style="padding: 15px 0px 0px 0px">
            <hr width="100%" size="1"/>
            <table width="100%" style="padding: 15px 0px 0px 0px">
              <tr>
EOF

    if [ -f sum-daily.html ]; then
	cat >> $main_index <<EOF
              <td width="200px" valign="top">
EOF

        generate_menu

        cat >> $main_index <<EOF
              </td>
              <td align="right" valign="top">
EOF

	generate_summaries

	cat >> $main_index <<EOF
              </td>
EOF
   else
      cat >> $main_index <<EOF
	<center>
	<i>No reports are available, please check back tomorrow morning.</i><br/>
	<i>Reports are generated every night automatically.</i>
	</center>
EOF
   fi

	cat >> $main_index <<EOF
              </tr>
            </table>
            <hr width="100%" size="1"/>
          </td>
          <!-- END CENTER CELL -->


          <td id="table_main_right"></td>
        </tr>
        <!-- END CONTENT AREA -->
EOF
}

generate_menu ()
{

cat >> $main_index <<EOF
                <!-- AVAILABLE REPORTS -->
                <table width="95%" border="1" bordercolor="bbbbbb" cellspacing="0" cellpadding="5">
                  <tr><td bgcolor="cccccc">
                    <h3><b>Available Reports:</b></h3>
                  </td></tr>
EOF

cat >> $main_index <<EOF
                  <tr><td>
                    > <a href="$index#EdgeGuard Appliance">EdgeGuard Appliance</a>
                  </td></tr>
EOF

for f in $tran_list; do
    if [ -d $f ]; then
        generate_menu_entry $f
    fi
done

cat >> $main_index <<EOF
                </table>
                <!-- END AVAILABLE REPORTS -->
EOF

}

generate_menu_entry ()
{
ls $1/*-daily.html >/dev/null 2>&1 || return
tran_dir=$1
tran_name=$(cat $tran_dir/name)

if [ "$tran_name" = "EdgeGuard Appliance" ]; then
    return;
fi

cat >> $main_index <<EOF
                  <tr><td>
                    > <a href="#$tran_name">$tran_name</a>
                  </td></tr>
EOF
echo "generating menu entry: $tran_name"
}

generate_summaries ()
{


cat >> $main_index <<EOF
              <!-- SUMMARY AREA -->
EOF

for f in $tran_list; do
    if [ -d $f ]; then
        generate_summary_entry $f false
    fi
done


for f in $tran_list; do
    if [ -d $f ]; then
        generate_summary_entry $f true
    fi
done

cat >> $main_index <<EOF
              <!-- END SUMMARY AREA -->
EOF
}

generate_summary_entry ()
{


# true allows you to print only non EdgeGuard Appliance appliances, false allows you to print only EdgeGuard Appliance
tran_dir=$1

ls $1/*-daily.html >/dev/null 2>&1 || return
tran_name=$(cat $tran_dir/name)

if [ "$2" = false ]; then
    if [ "$tran_name" != "EdgeGuard Appliance" ]; then
	return
    fi
else
    if [ "$tran_name" = "EdgeGuard Appliance" ]; then
	return
    fi
fi


rel_dir=$(echo $1 | sed -e 's/^\(.*\/current\/\)//')
#rel_dir=$(echo $1 | sed -e 's/^\(.*\/current\)/./')


# generate email argument list
if [ "$generate_email_index" = daily ]; then
    #find $rel_dir/images/* -type f >> $mail_reports_arguments
    #find $rel_dir/ -type f -name "summary*daily.html" >> $mail_reports_arguments
    #find $rel_dir/ -type d -name "summary*daily.html_files" -exec find {} -type f \; >> $mail_reports_arguments
    find $rel_dir/*daily.pdf -type f >> $mail_reports_arguments
fi

if [ "$generate_email_index" = weekly ]; then
    #find $rel_dir/images/* -type f >> $mail_reports_arguments
    #find $rel_dir/ -type f -name "summary*weekly.html" >> $mail_reports_arguments
    #find $rel_dir/ -type d -name "summary*weekly.html_files" -exec find {} -type f \; >> $mail_reports_arguments
    find $rel_dir/*weekly.pdf -type f >> $mail_reports_arguments
fi

if [ "$generate_email_index" = monthly ]; then
    #find $rel_dir/images/* -type f >> $mail_reports_arguments
    #find $rel_dir/ -type f -name "summary*monthly.html" >> $mail_reports_arguments
    #find $rel_dir/ -type d -name "summary*monthly.html_files" -exec find {} -type f \; >> $mail_reports_arguments
    find $rel_dir/*monthly.pdf -type f >> $mail_reports_arguments
fi



cat >> $main_index <<EOF
              <a name="$tran_name"/>
              <table width="95%" border="1" bordercolor="bbbbbb" cellspacing="0" cellpadding="5">
                <tr><td colspan="2" bgcolor="cccccc">
                  <table>
                  <tr>
                  <td style="padding: 0px 4px 0px 3px"><img src="$web_base/$rel_dir/images/IconOrg42x42.png" width="42" height="42"/></td>
EOF

if [ "$tran_name" != "EdgeGuard Appliance" ]; then
    cat >> $main_index <<EOF
                  <td style="padding: 0px 4px 0px 0px"><img src="$web_base/$rel_dir/images/IconDesc42x42.png" width="42" height="42"/></td>
EOF
fi

cat >> $main_index <<EOF
                  <td><h3><b>$tran_name Report</b></h3></td>
                  </tr>
                  </table>
                </td></tr>
                <tr>
                  <td>
                    <b>Vital Statistics:</b><br/>
EOF

generate_vital_statistics $1

cat >> $main_index <<EOF
                  </td>
                  <td>
                  <!--  <b>Visual Summary:</b><br/> -->
                  </td>
                </tr>
                <tr>
                  <td colspan="2">
                    <b>Detailed Reports:</b><br/>
EOF

generate_summary_detailed_entries $1

cat >> $main_index <<EOF
                  </td>
                </tr>
              </table>
<br/><br/>
EOF
echo "generating summary index : $tran_name : $2"
}

generate_vital_statistics ()
{
    cat >>$main_index <<EOF
<!-- VITAL STATISTICS -->
<table width="100%" style="padding: 0px 0px 0px 15px" cellspacing="0">
EOF

    tran_dir=$1
    tran_name=$(cat $tran_dir/name)
    rel_dir=$(echo $1 | sed -e 's/^\(.*\/current\/\)//')

if [ "$tran_name" = "EdgeGuard Appliance" ]; then
    if [ "$generate_email_index" = false ]; then
	cat $rel_dir/../sum-monthly.html | cat >> $main_index
    fi
    if [ "$generate_email_index" = daily ]; then
	cat $rel_dir/../sum-daily.html | cat >> $main_index
    fi
    if [ "$generate_email_index" = weekly ]; then
	cat $rel_dir/../sum-weekly.html | cat >> $main_index
    fi
    if [ "$generate_email_index" = monthly ]; then
	cat $rel_dir/../sum-monthly.html | cat >> $main_index
    fi
fi


if [ "$generate_email_index" = false ]; then
    cat $rel_dir/sum-monthly.html | cat >> $main_index
fi

if [ "$generate_email_index" = daily ]; then
    cat $rel_dir/sum-daily.html | cat >> $main_index
fi

if [ "$generate_email_index" = weekly ]; then
    cat $rel_dir/sum-weekly.html | cat >> $main_index
fi

if [ "$generate_email_index" = monthly ]; then
    cat $rel_dir/sum-monthly.html | cat >> $main_index
fi


cat >>$main_index <<EOF
</table>
<!-- END VITAL STATISTICS -->
EOF

}

generate_summary_detailed_entries ()
{
    tran_dir=$1
    tran_name=$(cat $tran_dir/name)
    rel_dir=$(echo $1 | sed -e 's/^\(.*\/current\/\)//')

    cat >>$main_index <<EOF
<!-- DETAILED REPORTS -->
<table width="100%" style="padding: 0px 0px 0px 15px" cellspacing="0">
<tr>
EOF

if [ "$generate_email_index" = false ]; then
cat >>$main_index <<EOF
<td width="*"></td>
<td width="125px" align="right"><i>daily</i></td>
<td width="125px" align="right"><i>weekly</i></td>
<td width="125px" align="right"><i>monthly</i></td>
EOF
fi

if [ "$generate_email_index" = daily ]; then
cat >>$main_index <<EOF
<td width="*" align="right" colspan="4"><i>daily</i></td>
EOF
fi

if [ "$generate_email_index" = weekly ]; then
cat >>$main_index <<EOF
<td width="*" align="right" colspan="4"><i>weekly</i></td>
EOF
fi
if [ "$generate_email_index" = monthly ]; then
cat >>$main_index <<EOF
<td width="*" align="right" colspan="4"><i>monthly</i></td>
EOF
fi

cat >>$main_index <<EOF
</tr>
EOF

alternate=0

cat $tran_dir/report-files | while read line; do
    base_name=$(echo $line | cut -d: -f2)
    rep_name=$(echo $line | cut -d: -f3-)
    if [ xsummarizer != "x$base_name" ]; then
        if (( alternate % 2 )); then
            color="dddddd"
	else
            color="eeeeee"
        fi
        cat >>$main_index <<EOF
<tr bgcolor=$color>
<td width="*">$rep_name: </td>
EOF

if [ "$generate_email_index" = false ]; then
cat >> $main_index <<EOF
<td width="125px" align="right">(<a href="$rel_dir/$base_name-daily.html">HTML</a> | <a href="$rel_dir/$base_name-daily.pdf">PDF</a>)</td>
<td width="125px" align="right">(<a href="$rel_dir/$base_name-weekly.html">HTML</a> | <a href="$rel_dir/$base_name-weekly.pdf">PDF</a>)</td>
<td width="125px" align="right">(<a href="$rel_dir/$base_name-monthly.html">HTML</a> | <a href="$rel_dir/$base_name-monthly.pdf">PDF</a>)</td>
EOF
else
#    if [ "`echo $rep_name | grep -i 'Summary' `x" != "x" ]; then
if [ "$generate_email_index" = daily ]; then
cat >> $main_index <<EOF
<td width="375px" align="right" colspan="3">(<a href="$rel_dir/$base_name-daily.pdf">PDF</a>)</td>
EOF
fi
if [ "$generate_email_index" = weekly ]; then
cat >> $main_index <<EOF
<td width="375px" align="right" colspan="3">(<a href="$rel_dir/$base_name-weekly.pdf">PDF</a>)</td>
EOF
fi
if [ "$generate_email_index" = monthly ]; then
cat >> $main_index <<EOF
<td width="375px" align="right" colspan="3">(<a href="$rel_dir/$base_name-monthly.pdf">PDF</a>)</td>
EOF
fi
#    else
#cat >> $main_index <<EOF
#<td width="375px" align="right" colspan="3"><i>Not attached to email.  Use EdgeReport online to view.</i></td>
#EOF
#    fi
fi

cat >>$main_index <<EOF
</tr>
EOF

alternate=$((alternate+1))
    fi
done

cat >>$main_index <<EOF
</table>
<!-- END DETAILED REPORTS -->
EOF

}

generate_page