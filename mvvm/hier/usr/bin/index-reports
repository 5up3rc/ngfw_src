#!/bin/sh

main_index=@MVVM_REPORTS@/current/$1
index=$1
period=$2
generate_email_index=$3
mail_reports_arguments_daily=@PREFIX@/tmp/mail_reports_arguments_daily.txt
mail_reports_arguments_weekly=@PREFIX@/tmp/mail_reports_arguments_weekly.txt
mail_reports_arguments_monthly=@PREFIX@/tmp/mail_reports_arguments_monthly.txt


if [ "$generate_email_index" != false ]; then
web_base=http://metavize.com/mail_blast
else
web_base=.
fi

cd @MVVM_REPORTS@/current


ordered_tran_list=`@USR_BIN@/mcli instances | awk '{print $2}' | sed 's|^\(.*\)$|@MVVM_REPORTS@/current/\1|'`


# generate email argument list
if [ "$generate_email_index" != false ]; then
    if [ "$period" = daily ]; then
	mail_reports_arguments="$mail_reports_arguments_daily"
    elif [ "$period" = weekly ]; then
	mail_reports_arguments="$mail_reports_arguments_weekly"
    elif [ "$period" = monthly ]; then
	mail_reports_arguments="$mail_reports_arguments_monthly"
    fi

    rm -f $mail_reports_arguments
    touch $mail_reports_arguments

    echo "--> mail_reports_arguments: $mail_reports_arguments"
fi



if [ "$generate_email_index" != false ]; then
    echo "-s \"Metavize EdgeReport ($period)\"" >> $mail_reports_arguments
    echo "./$index" >> $mail_reports_arguments
    find ./images/* -type f >> $mail_reports_arguments
fi

generate_page ()
{
cat > $main_index <<EOF

<html xmlns="http://www.w3.org/1999/xhtml">

  <!-- HEADING -->
  <head>
    <title>Metavize EdgeReport</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>


    <style type="text/css">
    <!--
body {
     margin: 15px;
     background: #FFFFFF url(http://metavize.com/mail_blast/images/background_body.gif) repeat-x top left;
     text-align: center;
}  

table {
    font: normal normal normal 10pt/14pt Arial,Sans-Serif;
    text-align: left;
    color: #606060;
}

input {
    font: normal normal normal 10pt/14pt Arial,Sans-Serif;
    text-align: left;
    color: #606060;
}

form {
    margin: 0px;
}

a:link, a:visited {
    font: normal normal normal 10pt/14pt Arial,Sans-Serif;
    color: #1997FE;
    text-decoration: none;
}

a:hover {
    color: #1997FE;
    text-decoration: underline;
}

.page_header_title {
    font: bold normal normal 25pt Arial,Sans-Serif;
    color: #777777;
}

.page_header_alternate {
    font: normal normal normal 15pt Arial,Sans-Serif;
    color: #777777;
}

h1 {
    font: normal normal bold 11pt Arial,Sans-Serif;
    color: #999999;
    letter-spacing: 1px;
    margin: 0px;
    padding: 0px;
}

h2 {
    font: normal normal bold 10pt Arial,Sans-Serif;
    color: #999999;
    letter-spacing: 1px;
    margin: 0px;
    padding: 0px;
}

h3 {
    font: normal normal bold 11pt Arial,Sans-Serif;
    color: #606060;
    letter-spacing: 1px;
    margin: 0px;
    padding: 0px;
}

h4 {
    font: normal normal bold 14pt Arial,Sans-Serif;
    color: #0044D7;
    letter-spacing: 1px;
    margin: 0px;
    padding: 0px;
}

/* the following pertain to the main content (i.e. the main 'metal-brushed') table */
#table_main_center {
    background: url(http://metavize.com/mail_blast/images/background_table_main_center.gif) repeat-y;
}

#table_main_top {
    background: url(http://metavize.com/mail_blast/images/background_table_main_top.gif) repeat-x;
}

#table_main_top_left {
    background: url(http://metavize.com/mail_blast/images/rounded_corner_main_top_left.gif) no-repeat;
}

#table_main_top_right {
    background: url(http://metavize.com/mail_blast/images/rounded_corner_main_top_right.gif) no-repeat;
}

#table_main_right {
    background: url(http://metavize.com/mail_blast/images/background_table_main_right.gif) repeat-y;
}

#table_main_bottom {
    background: url(http://metavize.com/mail_blast/images/background_table_main_bottom.gif) repeat-x;
}

#table_main_bottom_left {
    background: url(http://metavize.com/mail_blast/images/rounded_corner_main_bottom_left.gif) no-repeat;
}

#table_main_bottom_right {
    background: url(http://metavize.com/mail_blast/images/rounded_corner_main_bottom_right.gif) no-repeat;
}

#table_main_left {
    background: url(http://metavize.com/mail_blast/images/background_table_main_left.gif) repeat-y;
}
    -->
   </style>
  </head>

  <!--BRUSHED METAL PAGE BACKGROUND -->
  <body>
    <center>
      <table border="0" cellpadding="0" cellspacing="0" width="904">

        <!-- TOP THIRD -->
        <tr> 
          <td id="table_main_top_left">
            <img src="$web_base/images/spacer.gif" alt=" " width="23" height="23"/><br/>
          </td>
          <td width="100%" id="table_main_top">
            <img src="$web_base/images/spacer.gif" alt=" " width="1" height="1"/><br/>
          </td>
          <td id="table_main_top_right">
            <img src="$web_base/images/spacer.gif" alt=" " width="23" height="23"/><br/>
          </td>
        </tr>
        <!-- END TOP THIRD -->

        <!-- MIDDLE THIRD -->
        <tr> 
          <td id="table_main_left">
            <img src="$web_base/images/spacer.gif" alt=" " width="1" height="1"/>
          </td>
          <td id="table_main_center">
            <table width="100%">
              <tr>
              <td width="96" valign="middle">
                <img src="$web_base/images/logo_no_text_shiny_96x96.gif" alt="Metavize logo" width="96" height="96"/>
              </td>
              <td style="padding: 0px 0px 0px 10px" class="page_header_title" align="left" valign="middle">Metavize EdgeReport</td>
              <td class="page_header_alternate" align="right">
EOF

/bin/date +'%A %B %e, %Y' >> $main_index

if [ "$generate_email_index" = true ]; then
    if [ "$period" = daily ]; then
cat >> $main_index <<EOF
                <br/>(daily email)
EOF
    elif [ "$period" = weekly ]; then
cat >> $main_index <<EOF
                <br/>(weekly email)
EOF
    elif [ "$period" = monthly ]; then
cat >> $main_index <<EOF
                <br/>(monthly email)
EOF
    fi
else
    if [ "$period" = daily ]; then
cat >> $main_index <<EOF
                <br/>(daily online)
EOF
    elif [ "$period" = weekly ]; then
cat >> $main_index <<EOF
                <br/>(weekly online)
EOF
    elif [ "$period" = monthly ]; then
cat >> $main_index <<EOF
                <br/>(monthly online)
EOF
    fi
fi


cat >> $main_index <<EOF
              </td>
              </tr>
            </table>
          </td>
          <td id="table_main_right">
            <img src="$web_base/images/spacer.gif" alt=" " width="1" height="1"/>
          </td>
        </tr>
        <!-- END MIDDLE THIRD -->
EOF

generate_content_area

cat >> $main_index <<EOF

        <!-- BOTTOM THIRD -->
        <tr>
          <td id="table_main_bottom_left">
            <img src="$web_base/images/spacer.gif" alt=" " width="23" height="23"/><br/>
          </td>
          <td id="table_main_bottom">
            <img src="$web_base/images/spacer.gif" alt=" " width="1" height="1"/><br/>
          </td>
          <td id="table_main_bottom_right">
            <img src="$web_base/images/spacer.gif" alt=" " width="23" height="23"/><br/>
          </td>
        </tr>
        <!-- END BOTTOM THIRD -->

      </table>
    </center>

  </body>
  <!-- END BRUSHED METAL PAGE BACKGROUND -->

</html>

EOF
}

generate_content_area ()
{
cat >> $main_index <<EOF
        <!-- CONTENT AREA -->
        <tr>
          <td id="table_main_left"></td>

          <!-- CENTER CELL -->
          <td id="table_main_center" style="padding: 15px 0px 0px 0px">
            <hr width="100%" size="1" color="#969696"/>
            <table width="100%" style="padding: 15px 0px 0px 0px">
              <tr>
EOF

# XXX This should always be true:
    if [ -f reporting-transform/sum-daily.html ]; then
	cat >> $main_index <<EOF
              <td width="200px" valign="top">
EOF

	generate_period_menu
        generate_report_menu
	generate_key

        cat >> $main_index <<EOF
              </td>
              <td align="right" valign="top">
EOF

	generate_summaries

	cat >> $main_index <<EOF
              </td>
EOF
   else
      cat >> $main_index <<EOF
	<center>
	<i>No reports are available, please check back tomorrow morning.</i><br/>
	<i>Reports are generated every night automatically.</i>
	</center>
EOF
   fi

	cat >> $main_index <<EOF
              </tr>
            </table>
            <hr width="100%" size="1" color="969696"/>
          </td>
          <!-- END CENTER CELL -->


          <td id="table_main_right"></td>
        </tr>
        <!-- END CONTENT AREA -->
EOF
}

generate_period_menu ()
{
if [ "$generate_email_index" = false ]; then
cat >> $main_index <<EOF
                <table width="95%" border="1" bordercolor="bbbbbb" cellspacing="0" cellpadding="5">
                  <tr><td bgcolor="cccccc"><h3><b>Available Periods:</b></h3></td></tr>
                  <tr><td>> <a href="index_online_monthly.html">Monthly</a></td></tr>
                  <tr><td>> <a href="index_online_weekly.html">Weekly</a></td></tr>
                  <tr><td>> <a href="index.html">Daily</a></td></tr>
                </table>
<br/>
EOF
fi
}

generate_report_menu ()
{

cat >> $main_index <<EOF
                <!-- AVAILABLE REPORTS -->
                <table width="95%" border="1" bordercolor="bbbbbb" cellspacing="0" cellpadding="5">
                  <tr><td bgcolor="cccccc">
                    <h3><b>Available Reports:</b></h3>
                  </td></tr>
EOF

cat >> $main_index <<EOF
                  <tr><td>
                    > <a href="#EdgeGuard Appliance">EdgeGuard Appliance</a>
                  </td></tr>
EOF

for f in $ordered_tran_list; do
    if [ -d $f ]; then
        generate_report_menu_entry $f
    fi
done

cat >> $main_index <<EOF
                </table>
<br/>
                <!-- END AVAILABLE REPORTS -->
EOF

}

generate_key ()
{
cat >> $main_index <<EOF
<center>
<table border="0">
<tr><td><b>Key:</b><td></tr>
<tr><td>K = x 1,000<br/><td></tr>
<tr><td>M = x 1,000,000<br/><td></tr>
<tr><td>G = x 1,000,000,000<br/><td></tr>
</table>
</center>
EOF
}


generate_report_menu_entry ()
{
ls $1/*-daily.html >/dev/null 2>&1 || return
tran_dir=$1
tran_name=$(cat $tran_dir/name)

if [ "$tran_name" = "EdgeGuard Appliance" ]; then
    return;
fi

cat >> $main_index <<EOF
                  <tr><td>
                    > <a href="#$tran_name">$tran_name</a>
                  </td></tr>
EOF
echo "generating menu entry: $tran_name"
}

generate_summaries ()
{


cat >> $main_index <<EOF
              <!-- SUMMARY AREA -->
EOF

for f in $ordered_tran_list; do
    if [ -d $f ]; then
        generate_summary_entry $f false
    fi
done


for f in $ordered_tran_list; do
    if [ -d $f ]; then
        generate_summary_entry $f true
    fi
done

cat >> $main_index <<EOF
              <!-- END SUMMARY AREA -->
EOF
}

generate_summary_entry ()
{


# true allows you to print only non EdgeGuard Appliance appliances, false allows you to print only EdgeGuard Appliance
tran_dir=$1

ls $1/*-daily.html >/dev/null 2>&1 || return
tran_name=$(cat $tran_dir/name)

if [ "$2" = false ]; then
    if [ "$tran_name" != "EdgeGuard Appliance" ]; then
	return
    fi
else
    if [ "$tran_name" = "EdgeGuard Appliance" ]; then
	return
    fi
fi


rel_dir=$(echo $1 | sed -e 's/^\(.*\/current\/\)//')
#rel_dir=$(echo $1 | sed -e 's/^\(.*\/current\)/./')


# generate email argument list
if [ "$generate_email_index" = true ]; then
    if [ "$period" = daily ]; then
    #find $rel_dir/images/* -type f >> $mail_reports_arguments
    #find $rel_dir/ -type f -name "summary*daily.html" >> $mail_reports_arguments
    #find $rel_dir/ -type d -name "summary*daily.html_files" -exec find {} -type f \; >> $mail_reports_arguments
	find $rel_dir/*daily.pdf -type f >> $mail_reports_arguments
    elif [ "$period" = weekly ]; then
    #find $rel_dir/images/* -type f >> $mail_reports_arguments
    #find $rel_dir/ -type f -name "summary*weekly.html" >> $mail_reports_arguments
    #find $rel_dir/ -type d -name "summary*weekly.html_files" -exec find {} -type f \; >> $mail_reports_arguments
	find $rel_dir/*weekly.pdf -type f >> $mail_reports_arguments
    elif [ "$period" = monthly ]; then
    #find $rel_dir/images/* -type f >> $mail_reports_arguments
    #find $rel_dir/ -type f -name "summary*monthly.html" >> $mail_reports_arguments
    #find $rel_dir/ -type d -name "summary*monthly.html_files" -exec find {} -type f \; >> $mail_reports_arguments
	find $rel_dir/*monthly.pdf -type f >> $mail_reports_arguments
    fi
fi



cat >> $main_index <<EOF
              <a name="$tran_name"/>
              <table width="95%" border="1" bordercolor="bbbbbb" cellspacing="0" cellpadding="5">
                <tr><td colspan="2" bgcolor="cccccc">
                  <table>
                  <tr>
                  <td style="padding: 0px 4px 0px 3px"><img src="$web_base/$rel_dir/images/IconOrg42x42.png" width="42" height="42"/></td>
EOF

if [ "$tran_name" != "EdgeGuard Appliance" ]; then
    cat >> $main_index <<EOF
                  <td style="padding: 0px 4px 0px 0px"><img src="$web_base/$rel_dir/images/IconDesc42x42.png" width="42" height="42"/></td>
EOF
fi

cat >> $main_index <<EOF
                  <td><h3><b>$tran_name Report</b></h3></td>
                  </tr>
                  </table>
                </td></tr>
EOF



if [ -f $1/*Summary_Graph--daily.jpg ]; then
cat >> $main_index <<EOF
                <tr>
                  <td>
                     <b>Visual Summary:</b><br/>
EOF

generate_visual_summary $1

cat >> $main_index <<EOF
                  </td>
                </tr>
EOF
fi



cat >> $main_index <<EOF
                <tr>
                  <td>
                    <b>Vital Statistics:</b><br/>
EOF

generate_vital_statistics $1

cat >> $main_index <<EOF
                  </td>
                </tr>
                <tr>
                  <td colspan="2">
                    <b>Detailed Reports:</b><br/>
EOF

generate_detailed_reports $1

cat >> $main_index <<EOF
                  </td>
                </tr>
              </table>
<br/><br/>
EOF
echo "generating summary index : $tran_name : $2"
}

generate_vital_statistics ()
{
    cat >>$main_index <<EOF
<!-- VITAL STATISTICS -->
<table width="100%" style="padding: 0px 0px 0px 15px" cellspacing="0">
EOF

    tran_dir=$1
    tran_name=$(cat $tran_dir/name)
    rel_dir=$(echo $1 | sed -e 's/^\(.*\/current\/\)//')


    if [ "$period" = daily ]; then
	cat $rel_dir/sum-daily.html | cat >> $main_index
    elif [ "$period" = weekly ]; then
	cat $rel_dir/sum-weekly.html | cat >> $main_index
    elif [ "$period" = monthly ]; then
	cat $rel_dir/sum-monthly.html | cat >> $main_index
    fi


cat >>$main_index <<EOF
</table>
<!-- END VITAL STATISTICS -->
EOF

}


generate_visual_summary ()
{
    rel_dir=$(echo $1 | sed -e 's/^\(.*\/current\/\)//')
cat $tran_dir/report-files | while read line; do
    base_name=$(echo $line | cut -d: -f2)
    graph_name=$(echo $line | cut -d: -f3-)
    if [ xsummaryGraph = "x$base_name" ] ; then


cat >>$main_index <<EOF
<!-- VISUAL SUMMARY -->
<center>
<img src="$rel_dir/$graph_name--daily.jpg" width="600" height="200" alt="Visual Summary may take some additional time to load.  If it does not load, it may not viewable from this email client.  Please use your browser to view reports directly from EdgeGuard."/>
</center>
<!-- END VISUAL SUMMARY -->
EOF

echo "$rel_dir/$graph_name--daily.jpg" >> $mail_reports_arguments

fi
done
}


generate_detailed_reports ()
{
    tran_dir=$1
    tran_name=$(cat $tran_dir/name)
    rel_dir=$(echo $1 | sed -e 's/^\(.*\/current\/\)//')

    cat >>$main_index <<EOF
<!-- DETAILED REPORTS -->
<table width="100%" style="padding: 0px 0px 0px 15px" cellspacing="0">
<tr>
EOF

if [ "$generate_email_index" = false ]; then
cat >>$main_index <<EOF
<td width="*"></td>
<td width="125px" align="right"><i>daily</i></td>
<td width="125px" align="right"><i>weekly</i></td>
<td width="125px" align="right"><i>monthly</i></td>
EOF
else
    if [ "$period" = daily ]; then
cat >>$main_index <<EOF
<td width="*" align="right" colspan="4"><i>daily</i></td>
EOF
    fi
    if [ "$period" = weekly ]; then
cat >>$main_index <<EOF
<td width="*" align="right" colspan="4"><i>weekly</i></td>
EOF
    fi
    if [ "$period" = monthly ]; then
cat >>$main_index <<EOF
<td width="*" align="right" colspan="4"><i>monthly</i></td>
EOF
    fi
fi

cat >>$main_index <<EOF
</tr>
EOF

alternate=0

cat $tran_dir/report-files | while read line; do
    base_name=$(echo $line | cut -d: -f2)
    rep_name=$(echo $line | cut -d: -f3-)
    if [ xsummarizer != "x$base_name" ] && [ xsummaryGraph != "x$base_name" ] && [ xparameter != "x$base_name" ] ; then
        if (( alternate % 2 )); then
            color="dddddd"
	else
            color="eeeeee"
        fi
        cat >>$main_index <<EOF
<tr bgcolor=$color>
<td width="*">$rep_name: </td>
EOF

if [ "$generate_email_index" = false ]; then
cat >> $main_index <<EOF
<td width="125px" align="right">(<a href="$rel_dir/$base_name--daily.html">HTML</a> | <a href="$rel_dir/$base_name--daily.pdf">PDF</a>)</td>
<td width="125px" align="right">(<a href="$rel_dir/$base_name--weekly.html">HTML</a> | <a href="$rel_dir/$base_name--weekly.pdf">PDF</a>)</td>
<td width="125px" align="right">(<a href="$rel_dir/$base_name--monthly.html">HTML</a> | <a href="$rel_dir/$base_name--monthly.pdf">PDF</a>)</td>
EOF
else
#    if [ "`echo $rep_name | grep -i 'Summary' `x" != "x" ]; then
if [ "$period" = daily ]; then
cat >> $main_index <<EOF
<td width="375px" align="right" colspan="3">(<a href="$rel_dir/$base_name--daily.pdf">PDF</a>)</td>
EOF
fi
if [ "$period" = weekly ]; then
cat >> $main_index <<EOF
<td width="375px" align="right" colspan="3">(<a href="$rel_dir/$base_name--weekly.pdf">PDF</a>)</td>
EOF
fi
if [ "$period" = monthly ]; then
cat >> $main_index <<EOF
<td width="375px" align="right" colspan="3">(<a href="$rel_dir/$base_name--monthly.pdf">PDF</a>)</td>
EOF
fi
#    else
#cat >> $main_index <<EOF
#<td width="375px" align="right" colspan="3"><i>Not attached to email.  Use EdgeReport online to view.</i></td>
#EOF
#    fi
fi



alternate=$((alternate+1))
    fi
done

cat >>$main_index <<EOF
</table>
<!-- END DETAILED REPORTS -->
EOF

}

generate_page
