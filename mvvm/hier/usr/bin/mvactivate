#!/bin/sh

KEY_VERIFICATION="@MVVM_HOME@/conf/etc/mvverifykey"

REG_KEY="$1"

if [ -f "@MVVM_HOME@/activation.key" ]; then
    echo "Product has already been activated"
    exit 2
fi

$KEY_VERIFICATION $REG_KEY 2> /dev/null
VERIFY_RES="$?"
if [ "$VERIFY_RES" -eq 1 ]; then
    echo "Key is invalid: $REG_KEY"
    exit 1
fi
if [ "$VERIFY_RES" -ne 0 ]; then
    echo "Error validating registration.  Unable to continue."
    exit 2
fi

# If we get here, the key is good.
echo "Key is valid"

# This next will fail if testing on development machines, which is "a good thing"
echo "Installing sources list"
cat @MVVM_HOME@/conf/etc/apt_sources.list | sed "s/XXX_REG_KEY_XXX/$REG_KEY/" > @PREFIX@/etc/apt/sources.list

# Do this last, since once this file exists we cannot activate again
echo $REG_KEY > @MVVM_HOME@/activation.key
