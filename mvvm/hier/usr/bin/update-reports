#!/bin/sh

set -e

JAVA_HOME=${JAVA_HOME:-/opt/java}

CLASSPATH="@MVVM_HOME@/lib/mvvm.jar"

mars=$(@USR_BIN@/mcli instances | grep running | awk '{print $2}' | sed 's|^\(.*\)$|@MVVM_TOOLBOX@/\1.mar|')

for f in @THIRDPARTY_LIB@/*jar ; do
    CLASSPATH="$CLASSPATH:$f"
done

export JAVA_HOME CLASSPATH

REPORT_DIR=@MVVM_WEB@/reports

# roll up logs, deleting any more than 31 days old (and thus unreportable  on)
@USR_BIN@/rollup-logs 31

# make user mapping
psql -U metavize mvvm <<EOF
DROP TABLE addr_map;

CREATE TABLE addr_map (addr inet PRIMARY KEY, name varchar(64));

INSERT INTO addr_map
(SELECT addr, COALESCE(name, host(addr)) AS name
 FROM (SELECT addr, min(position) AS min_idx
       FROM (SELECT c_client_addr AS addr FROM pipeline_info
             UNION SELECT c_server_addr AS addr FROM pipeline_info
             UNION SELECT s_client_addr AS addr FROM pipeline_info
             UNION SELECT s_server_addr AS addr FROM pipeline_info
             UNION SELECT client_addr   AS addr FROM mvvm_login_evt) AS addrs
       LEFT OUTER JOIN ipmaddr_dir_entries entry JOIN ipmaddr_rule rule USING (rule_id)
       ON rule.ipmaddr >>= addr
       WHERE NOT addr ISNULL
       GROUP BY addr) AS pos_idxs
 LEFT OUTER JOIN ipmaddr_dir_entries entry JOIN ipmaddr_rule rule USING (rule_id)
 ON min_idx = position);
EOF

$JAVA_HOME/bin/java -Xmx512m \
    -Dlog4j.configuration=file:@MVVM_HOME@/conf/log4j-reporter.xml \
    com.metavize.mvvm.reporting.Reporter $REPORT_DIR 32 $mars

psql -U metavize mvvm <<EOF
DROP TABLE addr_map;
EOF

cp -pr $REPORT_DIR/images $REPORT_DIR/current

# generate the web viewable page
@PREFIX@/usr/bin/index-reports index.html false

# generate the emailable page
@PREFIX@/usr/bin/index-reports index_email_daily.html daily
@PREFIX@/usr/bin/index-reports index_email_weekly.html weekly
@PREFIX@/usr/bin/index-reports index_email_monthly.html monthly

# email the reports to all recipients
cd @PREFIX@/usr/share/metavize/web/reports/current
cat @PREFIX@/tmp/mail_reports_arguments_daily.txt | xargs @PREFIX@/usr/bin/mail-reports
cat @PREFIX@/tmp/mail_reports_arguments_weekly.txt | xargs @PREFIX@/usr/bin/mail-reports
cat @PREFIX@/tmp/mail_reports_arguments_monthly.txt | xargs @PREFIX@/usr/bin/mail-reports

# Just in case left over (we use a jsp now)
rm -f $REPORT_DIR/index.html
