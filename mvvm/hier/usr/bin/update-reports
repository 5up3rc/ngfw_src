#!/bin/sh

set -e

JAVA_HOME=${JAVA_HOME:-/opt/java}

CLASSPATH="@MVVM_HOME@/lib/util.jar:@MVVM_HOME@/lib/mvvm-client.jar"

mars=$(@USR_BIN@/mcli instances | grep running | awk '{print $2}' | sed 's|^\(.*\)$|@MVVM_TOOLBOX@/\1.mar|')

for f in @THIRDPARTY_LIB@/*jar ; do
    CLASSPATH="$CLASSPATH:$f"
done

export JAVA_HOME CLASSPATH

REPORT_DIR=@MVVM_WEB@/reports

# roll up logs, deleting any more than 31 days old (and thus unreportable  on)
@USR_BIN@/rollup-logs 31

# make user mapping
psql -U metavize mvvm <<EOF
DROP TABLE addr_map;

CREATE TABLE addr_map (addr inet PRIMARY KEY, name varchar(64));

INSERT INTO addr_map
(SELECT addr, COALESCE(name, host(addr)) AS name
 FROM (SELECT addr, min(position) AS min_idx
       FROM (SELECT c_client_addr AS addr FROM pipeline_info
             UNION SELECT c_server_addr AS addr FROM pipeline_info
             UNION SELECT s_client_addr AS addr FROM pipeline_info
             UNION SELECT s_server_addr AS addr FROM pipeline_info
             UNION SELECT client_addr   AS addr FROM mvvm_login_evt) AS addrs
       LEFT OUTER JOIN ipmaddr_dir_entries entry JOIN ipmaddr_rule rule USING (rule_id)
       ON rule.ipmaddr >>= addr
       WHERE NOT addr ISNULL
       GROUP BY addr) AS pos_idxs
 LEFT OUTER JOIN ipmaddr_dir_entries entry JOIN ipmaddr_rule rule USING (rule_id)
 ON min_idx = position);
EOF

$JAVA_HOME/bin/java \
    -Dlog4j.configuration=file:@MVVM_HOME@/conf/log4j-reporter.xml \
    com.metavize.mvvm.reporting.Reporter $REPORT_DIR 32 $mars

psql -U metavize mvvm <<EOF
DROP TABLE addr_map;
EOF

# generate the web viewable page
@PREFIX@/usr/bin/index-reports index.html false

# generate the emailable page
@PREFIX@/usr/bin/index-reports index_email.html true

# email the reports to all recipients
cd @PREFIX@/usr/share/metavize/web/reports/current
cat @PREFIX@/usr/bin/mail_reports_arguments.txt | xargs @PREFIX@/usr/bin/mail-reports

cat > $REPORT_DIR/index.html <<EOF
<html> <head> <title>Metavize EdgeReport</title>
<META HTTP-EQUIV="Refresh"
      CONTENT="5; URL=current/index.html">
</head>
<blockquote>
This page has moved. If your browser doesn't automatically redirect to
its new location, click
<a href="current/index.html">
here</a>.
</blockquote>
</body>
</html>
EOF

