#!/bin/sh

set -e

JAVA_HOME=${JAVA_HOME:-/opt/java}

CLASSPATH="@MVVM_HOME@/lib/util.jar:@MVVM_HOME@/lib/mvvm-client.jar"

mars=$(@USR_BIN@/mcli instances | grep running | awk '{print $2}' | sed 's|^\(.*\)$|@MVVM_TOOLBOX@/\1.mar|')

for f in @THIRDPARTY_LIB@/*jar ; do
    CLASSPATH="$CLASSPATH:$f"
done

export JAVA_HOME CLASSPATH

REPORT_DIR=@MVVM_WEB@/reports
mkdir -p $REPORT_DIR

# roll up logs
@USR_BIN@/rollup-logs

# make user mapping
psql -U metavize mvvm <<EOF
DROP TABLE addr_map;

CREATE TABLE addr_map (addr inet PRIMARY KEY, name varchar(64));

INSERT INTO addr_map
(SELECT addr, COALESCE(name, host(addr)) AS name
 FROM (SELECT addr, min(position) AS min_idx
       FROM (SELECT c_client_addr AS addr FROM pipeline_info
             UNION SELECT c_server_addr AS addr FROM pipeline_info
             UNION SELECT s_client_addr AS addr FROM pipeline_info
             UNION SELECT s_server_addr AS addr FROM pipeline_info) AS addrs
       LEFT OUTER JOIN ipmaddr_dir_entries entry JOIN ipmaddr_rule rule USING (rule_id)
       ON rule.ipmaddr >>= addr
       WHERE NOT addr ISNULL
       GROUP BY addr) AS pos_idxs
 LEFT OUTER JOIN ipmaddr_dir_entries entry JOIN ipmaddr_rule rule USING (rule_id)
 ON min_idx = position);
EOF

$JAVA_HOME/bin/java \
    -Dlog4j.configuration=file:@MVVM_HOME@/conf/log4j-reporter.xml \
    com.metavize.mvvm.reporting.Reporter $REPORT_DIR $mars

psql -U metavize mvvm <<EOF
DROP TABLE addr_map;
EOF

@PREFIX@/usr/bin/index-reports

