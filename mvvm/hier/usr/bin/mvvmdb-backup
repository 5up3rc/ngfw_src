#!/bin/sh

set -e

if [ $# -eq 0 ]; then
    echo "usage; $0 [ usb | local ] (out dir)"
    exit 1
fi

method=$1

outdir=@MVVM_DUMP@
if [ $# -eq 2 ]; then
  outdir=$2
fi

mkdir -p $outdir

case $method in
    usb)
        mount /dev/sda1 /mnt
        outdir=/mnt
        ;;
#    local)
#        outdir=@MVVM_DUMP@
#        ;;
esac

datestamp=$(date '+%Y%m%d%H%M')

(pg_dump -U postgres -n settings mvvm; pg_dump -U postgres -n events -s mvvm) \
    | gzip > $outdir/mvvmdb-$datestamp.gz

[ $? -eq 0 ] || exit 1

tar zcf $outdir/files-$datestamp.tar.gz --ignore-failed-read -C @PREFIX@/ \
        etc/hostname \
        etc/network/interfaces \
        etc/openvpn \
        etc/resolv.conf \
        usr/share/metavize/conf/argon.properties \
        usr/share/metavize/conf/keystore \
        usr/share/metavize/conf/mvvm.networking.properties \
        usr/share/metavize/conf/networking.sh \
        usr/share/metavize/conf/openvpn/misc \
        usr/share/metavize/conf/openvpn/pki \
        usr/share/metavize/conf/timezone

[ $? -eq 0 ] || exit 1    

mkg installed > $outdir/installed-$datestamp

[ $? -eq 0 ] || exit 1

if [ $method = "usb" ]; then
    umount /mnt
fi
