#!/bin/sh

REPORT_DIR=@MVVM_WEB@/reports

add_mv_htmlheader()
{
cat >>$hf <<EOF
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <link href="../css/main.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <table cellspacing="0" cellpadding="0" border="0" align="center" class="main">
      <tbody>
        <tr>
          <td class="main-top">
          </td>
        </tr>
        <tr>
          <td class="main-middle">
            <div align=center>
            <a href="$AHREFVAL"><font face="SansSerif" size="-1">back</font></a>
            </div>
EOF
}

add_mv_htmlfooter()
{
cat >>$hf <<EOF
            <div align=center>
            <a href="$AHREFVAL"><font face="SansSerif" size="-1">back</font></a>
            </div>
          </td>
        </tr>
        <tr>
          <td class="main-bottom">
          </td>
        </tr>
      </tbody>
    </table>
  </body>
</html>
EOF
}

ORG_PWD=`pwd`
NEW_PWD=$REPORT_DIR/current
cd $NEW_PWD

find * -type d > df.tmp
while read df
do
  if [ -f $df/name ]; then
    cd $df
    # note that index-reports uses content of transform name file to create anchor point on index html page
    TNAME=`cat name`

    find *.html -type f | grep -i "UserSummary--\(daily\|weekly\|monthly\)\.html" > uf.tmp
    while read uf
    do
      echo $uf | grep -i monthly &> /dev/null
      if [ $? -eq 1 ]; then
        echo $uf | grep -i weekly &> /dev/null
        if [ $? -eq 1 ]; then
          USDAILY=./$uf
        else
          USWEEKLY=./$uf
        fi
      else
        USMONTHLY=./$uf
      fi
    done < uf.tmp
    rm -f uf.tmp

    IDAILY=../index.html#$TNAME
    IWEEKLY=../index_online_weekly.html#$TNAME
    IMONTHLY=../index_online_monthly.html#$TNAME

    find *.html -type f | grep -iv "sum-\(daily\|weekly\|monthly\)\.html" | grep -iv "UserSummary--\(daily\|weekly\|monthly\)\.html" > hf.tmp
    while read hf
    do
      # note that update-reports chooses names of index html page files
      echo $hf | grep -i monthly &> /dev/null
      if [ $? -eq 1 ]; then
        echo $hf | grep -i weekly &> /dev/null
        if [ $? -eq 1 ]; then
          echo $hf | grep -i UserSummary &> /dev/null
          if [ $? -eq 1 ]; then
            AHREFVAL=$IDAILY
          else
            AHREFVAL=$USDAILY
          fi
        else
          echo $hf | grep -i UserSummary &> /dev/null
          if [ $? -eq 1 ]; then
            AHREFVAL=$IWEEKLY
          else
            AHREFVAL=$USWEEKLY
          fi
        fi
      else
        echo $hf | grep -i UserSummary &> /dev/null
        if [ $? -eq 1 ]; then
          AHREFVAL=$IMONTHLY
        else
          AHREFVAL=$USMONTHLY
        fi
      fi

      \mv -f $hf $hf.org

      # strip JR look-n-feel
      # (sed script file is customized for JR 1.1.1
      # - sed script file may need to be modified for other JR releases)
      sed -f @USR_BIN@/convert-reports.sed $hf.org > $hf.new

      # add MV look-n-feel
      add_mv_htmlheader
      cat $hf.new >> $hf
      add_mv_htmlfooter

      \rm -f $hf.org $hf.new
    done < hf.tmp
    rm -f hf.tmp

    cd $NEW_PWD
  fi
done < df.tmp
rm -f df.tmp

cd $ORG_PWD
