# UVM server settings -*-sh-*-

source @PREFIX@/etc/default/untangle-activation

MAX_HEAP_SIZE=320m #to be overwritten by untangle-hw
MAX_BERKDB_MEG=32 #to be overwritten by untangle-hw
MAX_VIRTUAL_SIZE=1100000 #to be overwritten by untangle-hw
GC_SAFETY_FACTOR=90 #to be overwritten by untangle-hw
GC_MIN_CYCLE=10 #to be overwritten by untangle-hw

if [ -f @PREFIX@/etc/default/untangle-hw ] ; then
    source @PREFIX@/etc/default/untangle-hw # this one is dynamically generated by hw-config
fi

#
# untangle-vm configuration
#
UVM_ARGS=""

UVM_LOGDIR=@PREFIX@/var/log/uvm
UVM_RUNDIR=@PREFIX@/var/run
UVM_CONSOLE_LOG=${UVM_CONSOLE_LOG:-$UVM_LOGDIR/console.log}
UVM_WRAPPER_LOG=$UVM_LOGDIR/wrapper.log
UVM_GC_LOG=$UVM_LOGDIR/gc.log
MONIT_LOG=$UVM_LOGDIR/monit.log
PACKAGES_LOG=$UVM_LOGDIR/packages.log
UVM_CMD=@PREFIX@/usr/bin/uvm
UVM_USER=root
UVM_YJP=${UVM_YJP=$:-no}
UVM_NICENESS=0

## if in the build, disable network configuration by default
#UVM_ARGS="${UVM_ARGS} -Duvm.devel.nonetworking=true"

## Set a session limit - defaults to 10k
#UVM_ARGS="${UVM_ARGS} -Dargon.sessionlimit=${UVM_SESSION_LIMIT}"

## Enable the heap monitor.
#UVM_ARGS="${UVM_ARGS} -Dcom.untangle.uvm.memmonitor.enabled=true"

## Rate, kilobytes/second to start dumping stack traces.
#UVM_ARGS="${UVM_ARGS} -Dcom.untangle.uvm.memmonitor.rate=$((3 * 1024)"

## required minimum to start dumping memory (even if rate exceeds rate)
#UVM_ARGS="${UVM_ARGS} -Dcom.untangle.uvm.memmonitor.min=$(( 100 * 1024 ))"

## Level at which to just dump memory regardless of the rate
#UVM_ARGS="${UVM_ARGS} -Dcom.untangle.uvm.memmonitor.level=$(( 310 * 1024 ))"

## Poll frequence in milliseconds
#UVM_ARGS="${UVM_ARGS} -Dcom.untangle.uvm.memmonitor.poll=500"

## Minimum number of milliseconds in between dumping two thread dumps
#UVM_ARGS="${UVM_ARGS} -Dcom.untangle.uvm.memmonitor.interval=3000"

## Name of the file where the log should go, if unspecified, this goes to console.log
#UVM_ARGS="${UVM_ARGS} -Dcom.untangle.uvm.memmonitor.file=heapmonitor.log"

## Lifetime for positive phonebook lookups (millis)
#UVM_ARGS="${UVM_ARGS} -Dcom.untangle.uvm.user.phonebook.lifetime=300000"

## Expiration time for host-bypassed sites (millis)
#UVM_ARGS="${UVM_ARGS} -Dcom.untangle.node.webfilter.bypass-timeout=3600000 -Dcom.untangle.node.webfilter.bypass-sleep-delay=1200000"

## Limit Berkeley DB caching to 5% of java heap
UVM_ARGS="${UVM_ARGS} -Dje.maxMemory=${MAX_BERKDB_MEG}"

## Reduce DNS caching to minimal (30 seconds).  
UVM_ARGS="${UVM_ARGS} -Dnetworkaddress.cache.ttl=30 -Dsun.net.inetaddr.ttl=30 -Dnetworkaddress.cache.negative.ttl=10"

## Alternative store
#UVM_ARGS="${UVM_ARGS} -Duvm.store.url=https://store.untangle.com"

## Default Logging
UVM_ARGS="${UVM_ARGS}  -Dlog4j.configuration=file:@PREFIX@/usr/share/untangle/conf/log4j-uvm.xml"

# If inside the devel environment 
if [ "x" != "x@PREFIX@" ] ; then
    ## Disable writing of networking config files
    UVM_ARGS="${UVM_ARGS} -Duvm.devel.nonetworking=true"
fi



#
# JAVA configuration
#
JAVA_HOME=@DEFAULT_JAVA6_HOME@
JAVA_OPTS=""
PATH=${JAVA_HOME}/bin:${PATH}

## Max Heap Size
JAVA_OPTS="${JAVA_OPTS} -Xmx${MAX_HEAP_SIZE}"

## Min Heap Size
JAVA_OPTS="${JAVA_OPTS} -Xms128m"

## Throughput Garbarge collector 
#JAVA_OPTS="${JAVA_OPTS} -XX:+UseParallelGC -XX:GCTimeRatio=6"

## Concurrent Garbarge collector
JAVA_OPTS="${JAVA_OPTS} -XX:+UseConcMarkSweepGC -XX:+CMSIncrementalMode -XX:+CMSIncrementalPacing -XX:CMSIncrementalDutyCycleMin=${GC_MIN_CYCLE} -XX:CMSIncrementalDutyCycle=50 -XX:CMSIncrementalSafetyFactor=${GC_SAFETY_FACTOR}"

## Garbage collector 
JAVA_OPTS="${JAVA_OPTS} -Xloggc:$UVM_GC_LOG -XX:+PrintGCDetails -XX:+PrintGCDateStamps"

## Garbage collector verbosity
JAVA_OPTS="${JAVA_OPTS} -verbose:gc"

## Server mode (optimizes code at startup)
JAVA_OPTS="${JAVA_OPTS} -server"

if [ `uname -m` != 'x86_64' ]; then
    ## Stack size
    JAVA_OPTS="${JAVA_OPTS} -Xss96k"
else
    ## Stack size
    JAVA_OPTS="${JAVA_OPTS} -Xss192k"
fi

# If inside the devel environment 
if [ "x" != "x@PREFIX@" ] ; then
    ## Enable assertions
    JAVA_OPTS="${JAVA_OPTS} -ea"
fi

export JAVA_OPTS
export JAVA_HOME
export PATH



#
# OEM configuration
#
if [ -f @PREFIX@/etc/untangle/oem/oem.sh ] ; then
    source @PREFIX@/etc/untangle/oem/oem.sh
else
    OEM_NAME="Untangle"
fi







