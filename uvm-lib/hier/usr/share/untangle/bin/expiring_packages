#!/bin/dash

get_expiring_nodes() {
    local t_date=$1
    local t_file

    shift
    for t_file in $* ; do
        if [ ! -f ${t_file} ]; then
            continue
        fi
        
        ## Don't send reports for nodes that have the full version
        if [ -f "${t_file%%-trial.ulf}-sub.ulf" ]; then
            continue
        fi

        ## All because mawk doesn't have strftime
        mackage=`awk '/com.untangle.uvm.license.mackage=/ { sub( "com.untangle.uvm.license.mackage=", "" ); print $0 }' ${t_file}` 
        end_time=`awk '/com.untangle.uvm.license.end=/{ sub( "com.untangle.uvm.license.end=", "" ) ; print $0 }' ${t_file}` 

        if [ -z "${mackage}" ]; then
            continue
        fi
        
        if [ -z "${end_time}" ]; then
            continue
        fi

        end_time=`ruby -e "puts Time.at( ${end_time} / 1000 ).strftime( '%y-%m-%d' )"`
        
        if [ "${end_time}" = "${t_date}" ]; then
            echo $mackage
        fi
    done
}

## Start of script
if [ "$#" -eq 0 ]; then
    echo "USAGE: $0 <yy-mm-dd (date to look for expiration)> [<license-file>]*"
    echo "\tlicense-file: if not specified, this will check all of the files /usr/share/untangle/conf/license/*-trial.ulf"
    exit -1
fi

EXPIRATION_DATE=$1
shift

if [ "$#" -eq 0 ]; then
    FILE_LIST=/usr/share/untangle/conf/licenses/*-trial.ulf
else
    FILE_LIST=$*
fi

get_expiring_nodes ${EXPIRATION_DATE} ${FILE_LIST} | sort | uniq



