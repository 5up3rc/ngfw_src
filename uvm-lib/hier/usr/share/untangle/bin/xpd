#! /bin/bash

GENERATOR_BASE=/usr/share/untangle/conf/licenses

t_generator="${GENERATOR_BASE}/${1}"
t_password=$2
t_prefix=$3
t_destination="${t_generator/.ulg/.ulf}"

if [ $# != 3 ]; then
    echo "${0} : incorrect usage"
    exit 0
fi

if [ "${t_generator%.ulg}x" = "${t_generator}" ]; then
    echo "${0} : incorrect suffix"
    exit 0
fi

if [ ! -f "${t_generator}" ]; then
    exit
fi

if [ -f "${t_destination}" ]; then
    rm -f ${t_generator}
    exit
fi

## key is is too long.
if [ `cat ${t_generator} | wc -l` -gt 128 ] ; then
   echo "license key is too long, exiting"
   exit 0
fi

script=`openssl enc -a -d -aes-128-cbc -salt -pass pass:${t_password} -in ${t_generator}`
md5hash=`echo "${script}" | tail -n 1`
script=`echo "${script}" | sed '$d'`
verify=`echo "${script}" | md5sum | awk '{ print "# MD5:" $1 }'`

if [ "x${md5hash}" != "x${verify}" ]; then
  echo "Hash doesn't match, exiting"
  exit 0
fi

echo "${script}" | bash /dev/stdin ${t_prefix} || true

if [ -f ${t_destination} ]; then
    rm -f ${t_generator}
fi

exit 0
