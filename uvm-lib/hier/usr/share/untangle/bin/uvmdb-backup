#! /bin/bash

if [ $# -eq 0 ]; then
    echo "usage; $0 (out dir)"
    exit 1
fi

outdir=$1
mkdir -p $outdir

datestamp=$(date '+%Y%m%d%H%M')

pg_dump -U postgres -n settings uvm | gzip > $outdir/uvmdb-$datestamp.gz

[ $? -eq 0 ] || exit 1

[ -x /usr/sbin/slapcat ] && /usr/sbin/slapcat -f /etc/untangle-ldap/slapd.conf -l @PREFIX@/usr/share/untangle/conf/dirbackup.ldif

## Run the script to backup the alpaca
[ -x  /usr/share/untangle-net-alpaca/scripts/backup ] && /usr/share/untangle-net-alpaca/scripts/backup @PREFIX@/usr/share/untangle/conf/alpaca-backup.uab "UVM Backup"

# FIXME XXX
[ -x  /usr/share/untangle-nas/scripts/backup ] && /usr/share/untangle-nas/scripts/backup @PREFIX@/usr/share/untangle/conf/nas-backup.uab "UVM Backup"

tar zcf $outdir/files-$datestamp.tar.gz --ignore-failed-read -C @PREFIX@/ \
    etc/hostname \
    etc/network/interfaces \
    etc/openvpn \
    etc/resolv.conf \
	etc/apache2/ssl \
    usr/share/untangle/conf/argon.properties \
    usr/share/untangle/conf/keystore \
    usr/share/untangle/conf/uvm.networking.properties \
    usr/share/untangle/conf/networking.sh \
    usr/share/untangle/conf/openvpn/misc \
    usr/share/untangle/conf/openvpn/pki \
    usr/share/untangle/conf/dirbackup.ldif \
    usr/share/untangle/conf/alpaca-backup.uab \
    usr/share/untangle/conf/nas-backup.uab

# Tar exits with non-zero when some files don't exist, which can happen.
# [ $? -eq 0 ] || exit 1

@UVM_HOME@/bin/ut-apt installed > $outdir/installed-$datestamp

[ $? -eq 0 ] || exit 1

