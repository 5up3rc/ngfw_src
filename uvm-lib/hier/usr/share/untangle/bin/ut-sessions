#!/bin/dash

first=0
count=0

echo "["

cat /proc/net/ip_conntrack | grep -v '127.0.0.1' | sed 's/\[.*\]//g' | sed 's/[a-z]*=//g' | while read i ; do
    if [ $first -eq 0 ] ; then first=1 ; else echo -n "," ; fi

    if [ "`echo $i | grep tcp`" ] ; then
        echo $i | awk '{printf "{ \"proto\":\"%s\", \"state\":\"%s\", \"src\":\"%s\", \"dst\":\"%s\", \"src-port\":\"%s\", \"dst-port\":\"%s\", \"packets\":\"%s\", \"bytes\":\"%s\", \"postNatSrc\":\"%s\", \"postNatDst\":\"%s\", \"qosPriority\":\"%x\", \"bypassed\":\"%i\" }\n", $1, $4, $5, $6, $7, $8, $9, $10, $12, $11, rshift(and($18,0x00700000),20), rshift(and($16,0x01000000),24)}'
    elif [ "`echo $i | grep udp`" ] ; then
        echo $i | awk '{printf "{ \"proto\":\"%s\", \"src\":\"%s\", \"dst\":\"%s\", \"src-port\":\"%s\",\"dst-port\",\"%s\", \"packets\":\"%s\", \"bytes\":\"%s\", \"postNatSrc\":\"%s\", \"postNatDst\":\"%s\", \"qosPriority\":\"%x\", \"bypassed\":\"%i\" }\n", $1, $4, $5, $6, $7, $8, $9, $11, $10, rshift(and($16,0x00700000),20), rshift(and($16,0x01000000),24)}'
    else
        #don't print it
        first=0
    fi

done

echo "]"
