#! /bin/bash

function is_rebooting()
{
    [ "$mode" = "restart" -a -e /var/run/uvm-reboot.pid ] \
        && ps p $(cat /var/run/uvm-reboot.pid) >/dev/null 2>&1
}

echo "$0 $@: $$ $(date)"

mode=$1

if [ "$mode" = "reboot" ]; then
    pidfile=/var/run/uvm-reboot.pid
else
    pidfile=/var/run/uvm-restart.pid
fi

echo $$ >$pidfile

while true; do
    if is_rebooting; then
        exit
    elif ps -C apt-get,aptitude,synaptic >/dev/null 2>&1; then
        sleep 1
    else
        # The upgrade is complete - stop showing the upgrade screen (regardless of mode)
        /usr/share/untangle/bin/ut-show-upgrade-splash stop

        # restart will have been scheduled by the time apt-get is gone
        if is_rebooting; then
            exit
        elif [ "xreboot" =  "x$mode" ]; then
            rm $pidfile
            reboot
            exit
        else
            rm $pidfile
            /etc/init.d/untangle-vm start
            exit
        fi
    fi
done
