#!/bin/dash

if [ -z "${IPTABLES}" ] ; then
   IPTABLES=/sbin/iptables
fi
SNORT_CHAIN=snort-scanning

NFQUEUE_QUEUE_NUM=$(python -c "from uvm.settings_reader import get_node_settings_item; print get_node_settings_item('untangle-node-idps','nfqueueQueueNum');")

${IPTABLES} -t mangle -N ${SNORT_CHAIN} 2>/dev/null
${IPTABLES} -t mangle -F ${SNORT_CHAIN} >/dev/null 2>&1

${IPTABLES} -t mangle -A ${SNORT_CHAIN} \
-i lo \
-j RETURN \
-m comment --comment "Bypass loopback traffic"

${IPTABLES} -t mangle -A ${SNORT_CHAIN} \
-o lo \
-j RETURN \
-m comment --comment "Bypass loopback traffic"

${IPTABLES} -t mangle -A ${SNORT_CHAIN} \
-j NFQUEUE --queue-num $NFQUEUE_QUEUE_NUM --queue-bypass \
-m mark ! --mark 0x1000000/0x1000000 \
-m connbytes --connbytes 0:1000 --connbytes-dir both --connbytes-mode bytes \
-m comment --comment "queue for snort"

${IPTABLES} -t mangle -D PREROUTING -j ${SNORT_CHAIN} -m comment --comment "snort scanning" >/dev/null 2>&1
${IPTABLES} -t mangle -A PREROUTING -j ${SNORT_CHAIN} -m comment --comment "snort scanning" 2>/dev/null
