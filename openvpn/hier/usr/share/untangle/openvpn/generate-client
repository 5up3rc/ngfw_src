#! /bin/bash

exec >> @UVM_LOG@/openvpn.log 2>&1

GLOBALS=@UVM_HOME@/openvpn/globals

## There must be a configuration file 
if [ -r ${GLOBALS} ]; then
    . ${GLOBALS}
else
    echo "Unable to load the openvpn configuration file ${GLOBALS}"
    exit -2
fi

## Convert spaces to _
commonName=`removeSpaces $1`

## Set if a revoked key should be recreated.
recreateCrt="${2}"

CLIENT_KEY=`getClientKeyFile ${commonName}`
CLIENT_CRT=`getClientCrtFile ${commonName}`

clientExists()
{
    if [ -f ${CLIENT_CRT} ]; then
        echo "The client ${commonName} already has a key"
        exit 0
    fi
    
    if [ -n "`isRevoked ${commonName}`" ] && [ -z "${recreateCrt}" ]; then
        echo "The client ${commonName} is revoked, and it was not requested that it be recreated"
        exit 0
    fi
}

validateBase() {
    if [ -z "${commonName}" ]; then
        echo "Must specify a common name for the key"
        exit -3
    fi
    
    ## Also have to check the ca.crt and the ca.key
    if [ ! -d ${PKI_DIR} ] || [ ! -d ${OPENVPN_DATA_DIR} ] || [ ! -f ${INDEX_FILE} ] || 
        [ ! -f ${SERIAL_FILE} ]; then
        echo "The base is not currently initialized"
        exit -4
    fi
}

generateClientKey()
{
    local clientCsr=`mktemp || exit -3`

    export COMMON_NAME=${commonName}
    export KEY_DN_QUALIFIER=${DN_QUALIFIER_CLIENT}
    
    ## Generate the server private key and the certificate signing request
    ${OPENSSL} req -days ${CERT_DURATION} -nodes -new -keyout ${CLIENT_KEY} -out ${clientCsr} \
        -config ${OPENSSL_CFG_FILE} -batch

    ## Sign the cretificate signing request
    ${OPENSSL} ca -days ${CERT_DURATION} -out ${CLIENT_CRT} -in ${clientCsr} \
        -config ${OPENSSL_CFG_FILE} -batch

    ## Remove the CSR
    ${RM_CMD} -f ${clientCsr}

    ## Make the server key readable only by root
    chmod 0600 ${CLIENT_KEY}
}

## Check if the client key has already been created
clientExists

## Validate that the base has been generated
validateBase

## Generate the client key
generateClientKey

## Update the client status file
updateClientStatus
