#! /bin/bash

RETRY_ATTEMPTS=5
RESTART_DELAY=2

# If the tun device doesn't exist, then create it
# https://forum.openwrt.org/viewtopic.php?id=15979
if [ ! -c /dev/net/tun ]; then
    mkdir -p /dev/net
    mknod /dev/net/tun c 10 200
fi

## Use restart just in case there is one lingering around
## For some reason "restart" is different stop then start
/etc/init.d/openvpn stop

## Just in case, kill all openvpn instances
killall openvpn > /dev/null 2>&1 

sleep .5

echo "Starting the openvpn server"

## This is required or else openvpn won't restart properly (sometimes the UDP port is still bound)
for (( t = 0 ; t < ${RETRY_ATTEMPTS} ; t++ )); do

    /etc/init.d/openvpn start

    if [ $? -eq 0 ] ; then 
        echo "Successfully started openvpn daemon"
        
        #FIXME should be elsewhere
        iptables -t filter -I filter-rules-input -p tcp --dport 1194 -j ACCEPT -m comment --comment "allow OpenVPN traffic"
        iptables -t filter -I filter-rules-input -p UDP --dport 1194 -j ACCEPT -m comment --comment "allow OpenVPN traffic"

        exit 0
    fi

    echo "Unable to start openvpn daemon, waiting ${RESTART_DELAY} seconds..."

    ## Just in case, kill all openvpn instances
    killall openvpn > /dev/null 2>&1 

    sleep ${RESTART_DELAY}
done


