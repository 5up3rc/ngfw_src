#! /bin/bash

# 
# This script imports a config file from a remote server
# and puts all the files in place so this server will connection to the remote server as a client
#

serverAddress=${1}
filename="${1}"
destination=`mktemp || -3`

logFile=@UVM_LOG@/openvpn.log


cleanup()
{
    if [ ! -z ${SITENAME} ] ; then
        rm -f /etc/openvpn/${SITENAME}.conf
    fi
    if [ ! -z ${TMPDIR} ] ; then
        rm -rf ${TMPDIR};  
    fi
    exit -1
}

if [ ! -f "${filename}" ]; then
    echo "Unable to find the file: ${filename}"
    exit -1
fi

TMPDIR=`mktemp -d || exit -3`

unzip -q ${filename} -d ${TMPDIR} || { rm -rf ${TMPDIR};  exit -1 ; }

CONFNAME="`ls ${TMPDIR}/untangle-vpn/*.conf`"

if [ -z "$CONFNAME" ] ; then
    echo "Missing conf file"
    exit -1
fi

SITENAME="`basename $CONFNAME | sed -e 's/.conf//'`"

# echo sitename to stdout
# This is important because the java code launching this script
# will use this to determine the site name. Do not remove.
echo "SiteName: ${SITENAME}" 

if [ -z "$SITENAME" ] ; then
    echo "Missing site name"
    exit -1
fi

## Copy in the necessary files
cp ${TMPDIR}/untangle-vpn/*.conf /etc/openvpn/${SITENAME}.conf

if [ $? != 0 ] ; then
    echo "Copy failed"
    cleanup
fi

## Update the configuration file to log to a normal place
sed -i -e "\$a log-append ${logFile}" /etc/openvpn/${SITENAME}.conf 

if [ $? != 0 ] ; then
    echo "Sed failed"
    cleanup
fi

mkdir -p /etc/openvpn/untangle-vpn
cp -r ${TMPDIR}/untangle-vpn/untangle-vpn/* /etc/openvpn/untangle-vpn 

if [ $? != 0 ] ; then
    echo "Copy 2 failed"
    echo ${TMPDIR}
    exit
    cleanup
fi

## Cleanup
rm -rf ${TMPDIR}

echo "New configuration imported: /etc/openvpn/${SITENAME}.conf"

true
